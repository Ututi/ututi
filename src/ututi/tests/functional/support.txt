Supporting Ututi
================

Users should be able to donate money to our application. All they have
to do is - log in:

    >>> from pylons import config
    >>> config['tpl_lang'] = 'lt'
    >>> browser = Browser.logIn()

And click 'Support us' button:

    >>> browser.getControl('Support now').click()

We get to the page where we can pick the ammount that we want to
transfer:

    >>> browser.getControl('50 litas').click()

They should get sent to the page that provides them different options
for payment:

    >>> browser.getControl('Dummy pay 50 LTL').click()

After paying, they get redirected to their profile thank you page:

    >>> browser.url
    'http://localhost/profile/thank_you'

They could have skipped the payment, and just clicked cancel:

    >>> browser.getLink('back to the profile').click()
    >>> browser.getControl('Support now').click()
    >>> browser.getControl('5 litas').click()
    >>> browser.getLink('Go back').click()

That would have sent them back to the profile as well:

    >>> browser.url
    'http://localhost/profile/no_thank_you'

The callback url that payment service would post to our application is
visible in the dummy payment page:

    >>> browser.getLink('back to the profile').click()
    >>> browser.getControl('Support now').click()
    >>> browser.getControl('10 litas').click()
    >>> url = browser.getLink('Process payment').url
    >>> url
    'http://localhost/process_transaction?status=1&lang=LIT&transaction=&name=Jonas&transaction2=&_ss2=&paytext=Remiam%20remiam&orderid=support_1&merchantid=xxx&currency=LTL&amount=1000&error=&test=1&surename=Petraitis&payment=Snoras&_ss1='

Let's click it, and register the payment in the database:

    >>> browser.getLink('Process payment').click()
    >>> browser.contents
    'OK'

    >>> from ututi.model import meta, Payment
    >>> payment = meta.Session.query(Payment).one()

    >>> payment.amount
    1000L
    >>> payment.user_id
    1L
    >>> payment.payment_type
    'support'

    >>> payment.referrer
    'http://localhost/pay'

    >>> print payment.query_string
    status=1&lang=LIT&transaction=&name=Jonas...

    >>> url.endswith(payment.query_string)
    True
