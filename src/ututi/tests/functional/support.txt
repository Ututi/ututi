Supporting Ututi
================

Users should be able to donate money to our application. All they have
to do is - log in:

    >>> from pylons import config
    >>> config['tpl_lang'] = 'lt'
    >>> browser = Browser.logIn()

And click 'Support us' button:

    >>> browser.getControl('Support now').click()

We get to the page where we can pick the ammount that we want to
transfer:

    >>> browser.getControl(name='50lt').click()

They should get sent to the page that provides them different options
for payment:

    >>> browser.getControl('Dummy pay 50 LTL').click()

After paying, they get redirected to their profile thank you page:

    >>> browser.url
    'http://localhost/profile/thank_you'

They could have skipped the payment, and just clicked cancel:

    >>> browser.getLink('back to the profile').click()
    >>> browser.getControl('Support now').click()
    >>> browser.getControl(name='5lt').click()
    >>> browser.getLink('Go back').click()

That would have sent them back to the profile as well:

    >>> browser.url
    'http://localhost/profile/no_thank_you'

The transaction has not been "registered" in the application, so the
supporter list should be empty:

    >>> browser.printQuery("id('supporter_list')")
    <ul id="supporter_list" class="show"></ul>

The callback url that payment service would post to our application is
visible in the dummy payment page:

    >>> browser.getLink('back to the profile').click()
    >>> browser.getControl('Support now').click()
    >>> browser.getControl(name='10lt').click()
    >>> url = browser.getLink('Process payment').url
    >>> url
    'http://localhost/process_transaction?wp_lang=LIT&wp_paytext=Remiam%20remiam&wp_name=Jonas&wp_projectid=&wp_orderid=support_1&wp_amount=1000&wp_status=1&wp_currency=LTL&wp_surename=Petraitis&wp_error=&wp_test=1&wp__ss1=&wp__ss2=&wp_p_email=admin%40ututi.lt'

Let's click it, and register the payment in the database:

    >>> browser.getLink('Process payment').click()
    >>> browser.contents
    'OK'

    >>> from ututi.model import meta, Payment
    >>> payment = meta.Session.query(Payment).one()

    >>> payment.amount
    1000L
    >>> payment.user_id
    1L
    >>> payment.payment_type
    'support'

    >>> payment.referrer
    'http://localhost/pay'

    >>> print payment.query_string
    wp_lang=LIT&wp_paytext=Remiam%20remiam&wp_name=Jonas&wp_projectid=&wp_orderid=support_1&wp_amount=1000&wp_status=1&wp_currency=LTL&wp_surename=Petraitis&wp_error=&wp_test=1&wp__ss1=&wp__ss2=&wp_p_email=admin%40ututi.lt

    >>> url.endswith(payment.query_string)
    True

As I have just paid, I should be in the supporter list:

    >>> browser.open('http://localhost')
    >>> browser.printQuery("id('supporter_list')")
    <ul id="supporter_list" class="show">
      <li>
        <a href="/user/1">Adminas Adminovix</a>
      </li>
    </ul>
