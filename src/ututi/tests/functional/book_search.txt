Tests for book search
=====================

Set up
------

    >>> browser = Browser.logIn()

    >>> from ututi.tests.functional import setUpBooks
    >>> setUpBooks(browser)
    >>> browser.open('http://localhost/books/')

Now let's find some books:

    >>> browser.click('search')
    >>> browser.printCssQuery('.book-title')

Hmm, we found no books, must be because we did not add any yet. Let's
fix that:

    >>> browser.click('Upload a Book')
    >>> browser.getControl('Book title').value = "My physics book"
    >>> browser.getControl('Author').value = "Mr. God"
    >>> browser.getControl(name="department").value = ['other']
    >>> browser.getControl('City').displayValue = ['Vilnius']
    >>> browser.getControl('Save').click()

Now let's go find it (empty search query returns all results):

    >>> browser.click('search')
    >>> browser.printCssQuery('.book-title')
    <h3 class="book-title">My physics book</h3>

Let's type some string that will not match neither the book title nor
the description:

    >>> browser.getControl('Search text').value = 'My maths book'
    >>> browser.click('search')

See, we found no books.

    >>> browser.printCssQuery('.book-title')

Entering physics returns the book though:

    >>> browser.getControl('Search text').value = 'physics'
    >>> browser.click('search')

    >>> browser.printCssQuery('.book-title')
    <h3 class="book-title">My physics book</h3>

The search term is displayed in the search box:

    >>> browser.getForm(id='search_form').getControl(name='text').value
    'physics'

In the search header area we have a dropdown that we can use to filter
our search results by city. By default it is set to 'all cities' and
displays the total amount of books that matched our search query:

    >>> browser.getControl(name='city').displayValue
    ['All cities (1)']

We can pick any city that has books matching our search criteria:

    >>> browser.getControl(name='city').displayOptions
    ['All cities (1)',
     'Vilnius (1)']

If we add one more book to this city, and another book to another
city, the widget should reflect that:

    >>> browser.click('Upload a Book')
    >>> browser.getControl('Book title').value = "My other physics book"
    >>> browser.getControl('Author').value = "Mr. Good"
    >>> browser.getControl(name='department').value = ['other']
    >>> browser.getControl('City').displayValue = ['Vilnius']
    >>> browser.getControl('Save').click()

    >>> browser.click('Upload a Book')
    >>> browser.getControl('Book title').value = "My other maths book"
    >>> browser.getControl('Author').value = "Goody good"
    >>> browser.getControl(name='department').value = ['other']
    >>> browser.getControl('City').displayValue = ['Kaunas']
    >>> browser.getControl('Save').click()

Now go to the search view:

    >>> browser.getControl('search').click()

    >>> browser.getControl(name='city').displayOptions
    ['All cities (3)',
     'Vilnius (2)',
     'Kaunas (1)']

If we enter a search query, only cities that have books matching the
query are displayed:

    >>> browser.getControl('Search text').value = 'physics'
    >>> browser.getControl('search').click()

    >>> browser.getControl(name='city').displayOptions
    ['All cities (2)',
     'Vilnius (2)']

We can also filter results by city:

    >>> browser.getControl('Search text').value = 'book'
    >>> browser.getControl('search').click()

    >>> browser.getControl(name='city').displayOptions
    ['All cities (3)',
     'Vilnius (2)',
     'Kaunas (1)']

    >>> browser.getControl(name='city').displayValue = ['Kaunas (1)']
    >>> browser.getControl('Filter').click()

And we only see the book from Kaunas now:

    >>> browser.printCssQuery('.book-title')
    <h3 class="book-title">My other maths book</h3>

The list of cities still has the same items (there still are 2 books
in Vilnius after all) but has Kaunas selected:

    >>> browser.getControl(name='city').displayOptions
    ['All cities (3)',
     'Vilnius (2)',
     'Kaunas (1)']

    >>> browser.getControl(name='city').displayValue
    ['Kaunas (1)']
