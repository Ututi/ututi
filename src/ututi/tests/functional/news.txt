
Some helper functions to list all the emails sent, and to set the
times of the events:

    >>> from ututi.lib.mailer import mail_queue
    >>> import datetime
    >>> from ututi.model import meta
    >>> from ututi.model.events import Event

    >>> def setEventTime(dt):
    ...     for event in meta.Session.query(Event).all():
    ...         event.created = dt

    >>> def printEmails():
    ...     for email in sorted(mail_queue, key=lambda e: e.recipients):
    ...         print email.recipients
    ...         print email.payload()

We log in:

    >>> browser = Browser.logIn()

Let's invite a couple of users into our group:

    >>> browser.getLink('Moderatoriai').click()
    >>> browser.getLink('Members').click()
    >>> browser.getControl(name='emails').value = ('user@ututi.lt\nuser2@ututi.lt')
    >>> browser.getControl('Invite').click()

    >>> Browser.logIn('user@ututi.lt', 'password').getControl('Accept').click()
    >>> Browser.logIn('user2@ututi.lt', 'password').getControl('Accept').click()

    >>> mail_queue[:] = []

Add their gadugadu numbers:

    >>> browser2 = Browser.logIn('user2@ututi.lt', 'password')
    >>> browser2.open('http://localhost/profile/edit')
    >>> browser2.getControl(name='gadugadu_uin').value = "564321"
    >>> browser2.getControl('Update contacts').click()

    >>> from ututi.lib import gg
    >>> gg.sent_messages[:] = []

Pretend we lost it ;)

    >>> browser2.getControl('send code again').click()
    >>> msg = gg.sent_messages.pop()
    >>> gg.sent_messages.pop()
    (564321L, u'To confirm your gadu gadu enter this code in your profile page.')

    >>> browser2.getControl(name='gadugadu_confirmation_key').value = msg[1]
    >>> browser2.getControl('OK').click()

    >>> browser2.getControl('Receive news into gg').click()
    >>> browser2.getControl('Update contacts').click()

    >>> browser3 = Browser.logIn('user@ututi.lt', 'password')
    >>> browser3.open('http://localhost/profile/edit')
    >>> browser3.getControl(name='gadugadu_uin').value = "133465"
    >>> browser3.getControl('Update contacts').click()

    >>> from ututi.lib import gg
    >>> msg = gg.sent_messages.pop()
    >>> ignore = gg.sent_messages.pop()
    >>> browser3.getControl(name='gadugadu_confirmation_key').value = msg[1]
    >>> browser3.getControl('OK').click()

    >>> browser3.getControl('Receive news into gg').click()

    >>> browser3.getControl('Update contacts').click()

    >>> browser3.getControl('Receive news into gg').selected
    True

Make some noise:

    >>> browser.getLink('Subjects').click()
    >>> browser.getControl('add a subject').click()
    >>> browser.getLink(url="/group/moderators/watch_subject").click()

    >>> browser.getLink(url='mat_analize').click()
    >>> browser.getLink('Edit').click()
    >>> browser.getControl('Tags').value = 'mat, analize'
    >>> browser.getControl('Save').click()

Let's look at the emails:

    >>> setEventTime(datetime.datetime(2009, 10, 10, 10, 15))
    >>> Browser.logIn().open('http://localhost/news/daily?date=2009-10-10')
    >>> printEmails()
    >>> mail_queue[:] = []

    >>> browser2.open(browser.url)

    >>> browser2.getControl('Create a wiki document').click()
    >>> browser2.getControl('Title').value = "How to be awesome!"
    >>> browser2.getControl('Content').value = "Being Awesome is easy!"
    >>> browser2.getControl('Save').click()

    >>> browser3.open(browser.url)

    >>> browser3.getControl('Create a wiki document').click()
    >>> browser3.getControl('Title').value = "How to be more awesome!"
    >>> browser3.getControl('Content').value = "Being more Awesome is easy too!"
    >>> browser3.getControl('Save').click()

    >>> browser.reload()
    >>> browser.getLink('How to be awesome!').click()
    >>> browser.getControl('edit').click()
    >>> browser.getControl('Content').value = "Being Awesome is hard!"
    >>> browser.getControl('Save').click()

    >>> browser.getControl('edit').click()
    >>> browser.getControl('Content').value = "Being Awesome is very hard!"
    >>> browser.getControl('Save').click()

Let's turn the time:

    >>> setEventTime(datetime.datetime(2009, 10, 9, 10, 15))

And look at the emails:

    >>> browser.open('http://localhost/news/daily?date=2009-10-10')

    >>> printEmails()
    ['admin@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user2@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>


    >>> mail_queue[:] = []

Now let's upload a couple of files:

    >>> res = app.post("/login",
    ...                params={'login': 'admin@ututi.lt', 'password': 'asdasd'})

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "f1.txt", "Test")])

Oh and in the mean time - a user sets his GG number to some nonsense:

    >>> browser3.open('http://localhost/profile/edit')
    >>> browser3.getControl(name='gadugadu_uin').value = ""
    >>> browser3.getControl('Update contacts').click()

And we continue uploading files:

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "f2.txt", "Test")])

    >>> browser.open('http://localhost/subject/vu/mat_analize')
    >>> browser.getControl(name='folder').value = 'A folder'
    >>> browser.getControl('create').click()

    >>> setEventTime(datetime.datetime(2009, 10, 9, 10, 15))
    >>> browser.open('http://localhost/news/daily?date=2009-10-10')

    >>> printEmails()
    ['admin@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user2@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>

    >>> mail_queue[:] = []

    >>> setEventTime(datetime.datetime(2009, 10, 8, 10, 15))
    >>> browser.open('http://localhost/news/daily?date=2009-10-10')

    >>> printEmails()
    >>> mail_queue[:] = []

Let's try hourly now:

    >>> browser.open('http://localhost/profile/subjects')
    >>> browser.getControl(name='each', index=1).displayValue
    ['at the end of the day']
    >>> browser.getControl(name='each', index=1).displayValue = ['immediatelly']
    >>> browser.getControl('Confirm', index=1).click()

    >>> browser.getControl(name='each', index=1).displayValue
    ['immediatelly']

    >>> meta.Session.commit()
    >>> browser.open('http://localhost/news/hourly?date=2009-10-08&hour=11')

    >>> printEmails()
    ['admin@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your
    subscription settings in your watched subject page
    (http://localhost/profile/subjects).
    <BLANKLINE>

    >>> mail_queue[:] = []

    >>> browser.open('http://localhost/news/hourly?date=2009-10-08&hour=10')
    >>> printEmails()

    >>> browser.open('http://localhost/news/hourly?date=2009-10-08&hour=12')
    >>> printEmails()

Admin should stop getting events in his daily news:

    >>> browser.open('http://localhost/news/daily?date=2009-10-09')

    >>> printEmails()
    ['user2@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>

    >>> mail_queue[:] = []

Unless he starts watching the subject himself:

    >>> browser.open('http://localhost/profile/subjects')
    >>> browser.getControl('Add a subject').click()
    >>> browser.getLink('Watch').click()

    >>> browser.open('http://localhost/news/daily?date=2009-10-09')

    >>> printEmails()
    ['admin@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user2@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>

    >>> mail_queue[:] = []

Hmm, now what happens if user2 starts ignoring the subject:

    >>> browser2.open('http://localhost/profile/subjects')
    >>> browser2.getLink(url='ignore_subject').click()

    >>> browser.open('http://localhost/news/daily?date=2009-10-09')
    >>> printEmails()
    ['admin@ututi.lt']
    Ututi news: 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be more awesome! (http://localhost/subject/vu/mat_analize/page/5) was created.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>
    ['user@ututi.lt']
    Ututi news: 2 new files and 2 new pages
    <BLANKLINE>
    Matematinė analizė (http://localhost/subject/vu/mat_analize)
    <BLANKLINE>
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was created.
    - Page How to be awesome! (http://localhost/subject/vu/mat_analize/page/3) was updated.
    - File f1.txt (http://localhost/subject/vu/mat_analize/file/9/get) was uploaded.
    - File f2.txt (http://localhost/subject/vu/mat_analize/file/10/get) was uploaded.
    <BLANKLINE>
    If you want to stop getting these emails - you can change your subscription settings in your watched subject page (http://localhost/profile/subjects).
    <BLANKLINE>

    >>> mail_queue[:] = []

    >>> from ututi.lib import gg
    >>> from pprint import pprint
    >>> for msg in gg.sent_messages: print msg
    (564321L, u'A new file has been uploaded for the Matematin\u0117 analiz\u0117:')
    (133465L, u'A new file has been uploaded for the Matematin\u0117 analiz\u0117:')
    (564321L, u'f1.txt (http://localhost:80/subject/vu/mat_analize/file/9/get)')
    (133465L, u'f1.txt (http://localhost:80/subject/vu/mat_analize/file/9/get)')
    (564321L, u'A new file has been uploaded for the Matematin\u0117 analiz\u0117:')
    (564321L, u'f2.txt (http://localhost:80/subject/vu/mat_analize/file/10/get)')

    >>> gg.sent_messages[:] = []

Regression test - file moves should not send events!

    >>> count = len(meta.Session.query(Event).all())

    >>> res = app.post("/subject/vu/mat_analize/file/9/move",
    ...                params={'target_folder': 'Some folder'})

    >>> len(meta.Session.query(Event).all()) == count
    True
