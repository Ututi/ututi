Group creation path
===================

First of all let's log in;

    >>> browser = Browser.logIn()

We can add a group at the url /groups/add.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'test'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl('Specify the school').value = 'Vilniaus universitetas'
    >>> browser.getControl('Save').click()

After creating the group we should be redirected to the subject selection view:

    >>> browser.printQuery('//h1/text()')
    Group Subjects
    Results:

We will skip this view for now, but it is an integral part of the group creation path.

    >>> browser.getLink('Finish choosing subjects').click()
    >>> browser.printQuery('//h1/text()')
    Group members

Let us fill in several email to be invited.
    >>> browser.getControl('Enter emails of the people You would like to invite to the group.').value='user@ututi.lt, jonas@example.com, admin@ututi.lt'
    >>> browser.getControl('Invite').click()

The users should get emails:

    >>> from ututi.lib.mailer import mail_queue
    >>> msg = mail_queue.pop().message
    >>> print msg
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: jonas@example.com
    Subject: Ututi group invitation
    <BLANKLINE>
    Adminas Adminovix has invited You to join the group Test group.
    <BLANKLINE>
    Since You do not appear to be a Ututi user at the moment, to become a member of this group, You will have to register first.
    <BLANKLINE>
    You can do this by following this link: http://localhost/register/...
    <BLANKLINE>
    The Ututi team
    <BLANKLINE>

And another message, this time to somebody who already is a ututi user:

    >>> print mail_queue.pop().message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: user@ututi.lt
    Subject: Ututi group invitation
    <BLANKLINE>
    Alternative user,
    <BLANKLINE>
    Adminas Adminovix has invited You to join the group Test group.
    <BLANKLINE>
    You can accept or reject this invitation by following this link: http://localhost/group/test/invitation .
    <BLANKLINE>
    The Ututi team
    <BLANKLINE>

Now, if we were to sign in as this 'alternative user' user, we should see a flash message notifying us of the
invitation.

    >>> browser2 = Browser()
    >>> browser2.open('http://localhost/')
    >>> form = browser2.getForm('login_form')
    >>> form.getControl('Email').value = "user@ututi.lt"
    >>> form.getControl('Password').value = "password"
    >>> form.getControl('Login').click()

    >>> browser2.printQuery("//div[@class='flash-message']/span/text()")
    <BLANKLINE>
                      Adminas Adminovix has sent you an invitation to group Test group. Do You want to become a member of this group?
    <BLANKLINE>

Let's accept this invitation.

    >>> browser2.getControl("Accept").click()
    >>> browser2.printQuery("//div[@class='flash-message']/span/text()")
    Close
    Congratulations! You are now a member of the group 'Test group'

Let's get the url from the first message

    >>> from  ututi.lib.helpers import get_urls
    >>> print get_urls(msg)
    ['http://localhost/register/...']

First let us log out.

    >>> browser.getLink('Log out').click()
    >>> browser.open(get_urls(msg)[0])
    >>> browser.printQuery('//h1/text()')
    UTUTI - student information online

Let us fill out the registration form

    >>> form = browser.getForm(id='registration_form')
    >>> form.getControl('Fullname').value = 'Jonas Petraitis Petrauskas'
    >>> form.getControl('Email').value = 'jonas@example.com'
    >>> form.getControl('Password').value = 'asdfgh'
    >>> form.getControl('Repeat password').value = 'asdfgh'
    >>> form.getControl('Register').click()

We should get an email confirmation request:

    >>> print mail_queue.pop().message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: jonas@example.com
    Subject: Confirm the email for Ututi
    <BLANKLINE>
    We have received a request to confirm the ownership of this email by Jonas Petraitis Petrauskas on the Ututi system. If this email belongs to You, confirm it by clicking on this link:
    <BLANKLINE>
    http://localhost/confirm_user_email/...
    <BLANKLINE>
    Ututi team
    <BLANKLINE>

And we are redirected to the group that invited us.

    >>> browser.url
    'http://localhost/group/test'

    >>> browser.open("http://localhost/group/test/members")
    >>> browser.getControl('Enter emails of the people You would like to invite to the group.').value = 'user3@ututi.com'
    >>> browser.getControl('Invite').click()
    >>> print mail_queue.pop().message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: user3@ututi.com
    Subject: Ututi group invitation
    <BLANKLINE>
    Jonas Petraitis Petrauskas has invited You to join the group Test group.
    <BLANKLINE>
    Since You do not appear to be a Ututi user at the moment, to become a member of this group, You will have to register first.
    <BLANKLINE>
    You can do this by following this link: http://localhost/register/...
    <BLANKLINE>
    The Ututi team
    <BLANKLINE>

Let's try requesting to join the group:
    >>> browser3 = Browser()
    >>> browser3.open('http://localhost/')
    >>> form = browser3.getForm('login_form')
    >>> form.getControl('Email').value = "user2@ututi.lt"
    >>> form.getControl('Password').value = "password"
    >>> form.getControl('Login').click()

    >>> browser3.open('http://localhost/group/test')
    >>> browser3.getControl('Join the group').click()
    >>> browser3.printQuery("//div[@class='flash-message']/span/text()")
    Close
    Your request to join the group was forwarded to the group's administrators. Thank You!

The group's administrator should now see the request in the members view.

    >>> browser.getLink('Log out').click()
    >>> browser.open('http://localhost/')
    >>> form = browser.getForm('login_form')
    >>> form.getControl('Email').value = "admin@ututi.lt"
    >>> form.getControl('Password').value = "asdasd"
    >>> form.getControl('Login').click()

    >>> browser.getLink('Test group').click()
    >>> browser.getLink('Members').click()

    >>> print browser.url
    http://localhost/group/test/members

    >>> browser.getControl('Confirm').click()

And the new member should be able to access the group now.
    >>> browser3.open('http://localhost/group/test/members')
    >>> browser3.printQuery("//div[@class='user-logo-link']/div/a/text()")
    Adminas Adminovix
    Alternative user
    Jonas Petraitis Petrauskas
    Second user

