User registration
=================

Our new users will be greated by a page that has a registration form
in it:

    >>> response = app.get('/')
    >>> form = response.forms['registration_form']

We will only require your email address, name and password:

    >>> form.set('fullname', 'Jonas Petraitis Petrauskas')
    >>> form.set('email', 'jonas@example.com')
    >>> form.set('new_password', 'asdfgh')
    >>> form.set('repeat_password', 'asdfgh')
    >>> response = form.submit()

After registration is complete we should be hailed by our welcome
screen:
    >>> response = response.follow()
    >>> print response.lxml.xpath("//body/h1")[0].text
    Welcome!

An email, requesting the confirmation of the email address entered is sent:
    >>> from ututi.lib.mailer import mail_queue
    >>> email = mail_queue.pop()
    >>> print email['To']
    jonas@example.com
    >>> from ututi.lib.helpers import get_urls
    >>> urls = get_urls(email.get_payload())
    >>> len(urls) == 1
    True
    >>> response = app.get(urls[0])
    >>> response = response.follow()
    >>> print response.lxml.xpath("id('confirmed-emails')/li")[0].text
    jonas@example.com

We have been logged in after signing up. Now let's log out and test more unfortunate
scenarios:
    >>> response = app.get('/')
    >>> response = response.click('Log out')
    >>> response = response.follow()
    >>> response.request.url
    'http://localhost/?came_from=%2F'

    >>> "registration_form" in response.forms
    True

If we forget to enter the username, we get returned to the registration form, but an error
message is shown:
    >>> form = response.forms['registration_form']
    >>> form.set('email', 'jonas2@example.com')
    >>> form.set('fullname', '')
    >>> form.set('new_password', 'asdfgh')
    >>> form.set('repeat_password', 'asdfgh')
    >>> response = form.submit()
    >>> response.request.url
    'http://localhost/register'

    >>> 'registration_form' in response.forms
    True

    >>> print response.lxml.xpath("//span[@class='error-message']")[0].text
    Please enter your name to register.

Ok, now we forget to enter the email when registering. We should be redirected to the
registration form and shown an error message that we've forgotten the email.
    >>> form = response.forms['registration_form']
    >>> form.set('fullname', 'Domas Monkus')
    >>> form.set('email', '')
    >>> form.set('new_password', 'asdfgh')
    >>> form.set('repeat_password', 'asdfgh')
    >>> response = form.submit()
    >>> response.request.url
    'http://localhost/register'

    >>> 'registration_form' in response.forms
    True

    >>> print response.lxml.xpath("//span[@class='error-message']")[0].text
    Please enter an email address

If we forget to enter the password, we should also get an error message.
    >>> form = response.forms['registration_form']
    >>> form.set('fullname', 'Domas Monkus')
    >>> form.set('email', 'jonas2@example.com')
    >>> form.set('new_password', '')
    >>> form.set('repeat_password', '')
    >>> response = form.submit()
    >>> response.request.url
    'http://localhost/register'

    >>> 'registration_form' in response.forms
    True

    >>> print response.lxml.xpath("//span[@class='error-message']")[0].text
    Please enter your password to register.

If the passwords do not match we also get an error message.
    >>> form = response.forms['registration_form']
    >>> form.set('fullname', 'Domas Monkus')
    >>> form.set('email', 'jonas2@example.com')
    >>> form.set('new_password', 'asdfgh')
    >>> form.set('repeat_password', 'asdfghj')
    >>> response = form.submit()
    >>> response.request.url
    'http://localhost/register'

    >>> 'registration_form' in response.forms
    True

    >>> print response.lxml.xpath("//span[@class='error-message']")[0].text
    Passwords do not match.

If such an email already exists, we also get an error message (later we should get a link to reset the password if
we have forgotten it).
    >>> form = response.forms['registration_form']
    >>> form.set('fullname', 'Domas Monkus')
    >>> form.set('email', 'jonas@example.com')
    >>> form.set('new_password', 'asdfgh')
    >>> form.set('repeat_password', 'asdfgh')
    >>> response = form.submit()
    >>> response.request.url
    'http://localhost/register'

    >>> 'registration_form' in response.forms
    True

    >>> print response.lxml.xpath("//span[@class='error-message']")[0].text
    This email has already been used to register.




