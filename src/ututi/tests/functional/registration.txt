User registration
=================

Our new users will be greated by a page that has a registration form
in it:

    >>> browser = Browser()
    >>> browser.open('http://localhost/')
    >>> form = browser.getForm('registration_form')

We will only require your email address, name and password:

    >>> form.getControl('Fullname').value = 'Jonas Petraitis Petrauskas'
    >>> form.getControl('Email').value = 'jonas@example.com'
    >>> form.getControl('Password').value = 'asdfgh'
    >>> form.getControl('Repeat password').value = 'asdfgh'
    >>> form.getControl('Register').click()

After registration is complete we should be hailed by our welcome
screen:

    >>> browser.printQuery("id('page-content')//h3/text()")
    Join a group
    Review and edit your profile

    >>> browser.getControl(name='location-0').value = 'vu'
    >>> browser.getControl(name='year').value = ['2009']
    >>> browser.getControl('Search').click()
    >>> browser.printQuery("id('search-results')//a/text()")
    Moderatoriai


An email, requesting the confirmation of the email address entered is sent:

    >>> from ututi.lib.mailer import mail_queue
    >>> email = mail_queue.pop()
    >>> print email.message
    MIME-Version: 1.0
    ...
    From: info@ututi.lt
    To: jonas@example.com
    Subject: Confirm the email for Ututi
    <BLANKLINE>
    We have received a request to confirm the ownership of this email
    by Jonas Petraitis Petrauskas on the Ututi system. If this email
    belongs to You, confirm it by clicking on this link:
    <BLANKLINE>
    http://localhost/confirm_user_email/...
    <BLANKLINE>
    Ututi team

    >>> print email.recipients
    jonas@example.com

    >>> from ututi.lib.helpers import get_urls
    >>> urls = get_urls(email.message)
    >>> len(urls) == 1
    True
    >>> browser.open(urls[0])
    >>> browser.printQuery("id('confirmed-emails')/li/text()")
    jonas@example.com

We have been logged in after signing up. Now let's log out and test more unfortunate
scenarios:

    >>> browser.open('http://localhost/')
    >>> browser.getLink('Log out').click()
    >>> browser.url
    'http://localhost/?came_from=http%3A%2F%2Flocalhost%2F'

If we forget to enter the username, we get returned to the registration form, but an error
message is shown:

    >>> form = browser.getForm('registration_form')
    >>> form.getControl('Email').value = 'jonas2@example.com'
    >>> form.getControl('Password').value = 'asdfgh'
    >>> form.getControl('Repeat password').value = 'asdfgh'
    >>> form.getControl('Register').click()
    >>> browser.url
    'http://localhost/register'

    >>> browser.printQuery("//span[@class='error-message']/text()")
    Please enter your name to register.

Ok, now we forget to enter the email when registering. We should be redirected to the
registration form and shown an error message that we've forgotten the email.

    >>> form = browser.getForm('registration_form')
    >>> form.getControl('Fullname').value = 'Domas Monkus'
    >>> form.getControl('Password').value = 'asdfgh'
    >>> form.getControl('Repeat password').value = 'asdfgh'
    >>> form.getControl('Email').value = ''
    >>> form.getControl('Register').click()
    >>> browser.url
    'http://localhost/register'

    >>> browser.printQuery("//span[@class='error-message']/text()")
    Please enter an email address

If we forget to enter the password, we should also get an error message.

    >>> form = browser.getForm('registration_form')
    >>> form.getControl('Fullname').value = 'Domas Monkus'
    >>> form.getControl('Email').value = 'domas@ututi.com'
    >>> form.getControl('Password').value = ''
    >>> form.getControl('Repeat password').value = ''
    >>> form.getControl('Register').click()
    >>> browser.url
    'http://localhost/register'

    >>> browser.printQuery("//span[@class='error-message']/text()")
    Please enter your password to register.
    Please enter your password to register.

If the passwords do not match we also get an error message.

    >>> form = browser.getForm('registration_form')
    >>> form.getControl('Fullname').value = 'Domas Monkus'
    >>> form.getControl('Password').value = 'abcdefgh'
    >>> form.getControl('Repeat password').value = 'abcdef'
    >>> form.getControl('Email').value = 'jonas3@example.com'
    >>> form.getControl('Register').click()
    >>> browser.url
    'http://localhost/register'

    >>> browser.printQuery("//span[@class='error-message']/text()")
    Passwords do not match.

If such an email already exists, we also get an error message (later we should get a link to reset the password if
we have forgotten it).

    >>> form = browser.getForm('registration_form')
    >>> form.getControl('Fullname').value = 'Domas Monkus'
    >>> form.getControl('Password').value = 'abcdefgh'
    >>> form.getControl('Repeat password').value = 'abcdefgh'
    >>> form.getControl('Email').value = 'jonas@example.com'
    >>> form.getControl('Register').click()
    >>> browser.url
    'http://localhost/register'

    >>> browser.printQuery("//span[@class='error-message']/text()")
    This email has already been used to register.

