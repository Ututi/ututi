Tests for ajax file management views
====================================

File upload:

    >>> res = app.post("/login",
    ...                params={'login': 'admin@ututi.lt', 'password': 'asdasd'})

    >>> from textwrap import dedent
    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "text;for you.txt", "Test")])
    >>> print dedent(res.body)
    <BLANKLINE>
    <li class="file">
      <img alt="file icon" class="drag-target" src="/images/details/icon_drag_file_new.png" />
      <a class="filename" href="/subject/vu/mat_analize/file/3/get">text;for you.txt</a>
      <span class="file_rename_form hidden">
        <span class="file_rename_input_decorator">
          <input class="file_rename_input" type="text" />
        </span>
        <div class="form-field"><span class="btn"><input class="rename_confirm btn" type="submit" value="Rename" /></span></div>
      </span>
      <img src="/images/details/icon_rename.png" alt="edit file name" class="rename_button" />
      <span class="size">(4.0 b)</span>
      <span class="date">...</span>
      <a href="/user/1" class="author">
        Adminas Adminovix
      </a>
      <input class="move_url" type="hidden" value="/subject/vu/mat_analize/file/3/move" />
      <input class="copy_url" type="hidden" value="/subject/vu/mat_analize/file/3/copy" />
      <input class="delete_url" type="hidden" value="/subject/vu/mat_analize/file/3/delete" />
      <input class="rename_url" type="hidden" value="/subject/vu/mat_analize/file/3/rename" />
      <input class="folder_title_value" type="hidden" value="" />
      <img src="/images/delete.png" alt="delete file" class="delete_button" />
    </li>
    <BLANKLINE>

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Some folder'},
    ...                upload_files=[("attachment", r"c:\My Home\image.png", "Tst")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/subject/vu/mat_analize/file/4/get">image.png</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/file_info",
    ...                params={'section_id': 0})
    >>> print res.body
    {"text": "\n  <div class=\"area_size\">free space: 20.0 b</div>\n", "image": "\n  <img alt=\"0.0 b\" class=\"area_size_points\" src=\"/images/details/pbar0.png\" />\n", "section_id": "0"}

    >>> res = app.post("/group/moderators/upload_status",
    ...                params={'section_id': 0})
    >>> print res.body
    {"status": 2, "section_id": "0"}

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "other_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/group/moderators/file/5/get">other_text.txt</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder'},
    ...                upload_files=[("attachment", "more_text.txt", "Tst")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/group/moderators/file/6/get">more_text.txt</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/file_info",
    ...                params={'section_id': 0})
    >>> print res.body
    {"text": "\n  <div class=\"area_size\">free space: 8.0 b</div>\n", "image": "\n  <img alt=\"12.0 b\" class=\"area_size_points\" src=\"/images/details/pbar3.png\" />\n", "section_id": "0"}

    >>> res = app.post("/group/moderators/upload_status",
    ...                params={'section_id': 0})
    >>> print res.body
    {"status": 1, "section_id": "0"}

Empty folder creation:

    >>> res = app.post("/subject/vu/mat_analize/js_create_folder",
    ...                params={'folder': 'Buga Buga',
    ...                        'section_id': '7'})
    >>> print dedent(res.body)
    <div class="target_item "><div class="upload target" id="file_upload_button...">Buga Buga</div></div>
        <div class="folder_file_area subfolder click2show" id="file_area...">
          <input class="folder_name" id="file_folder_name-..." type="hidden" value="Buga Buga" />
          <h4 class="">
            <span class="cont">
              Buga Buga
              <span class="small">(0 files)</span>
                <a  href="/subject/vu/mat_analize/delete_folder?folder=Buga+Buga" id="delete_folder_button..." class="delete_folder_button">(Delete)</a>
            </span>
          </h4>
          <ul class="folder">
                <li class="message">There are no files here, this folder is empty!</li>
            </ul>
        </div>

    >>> browser = Browser.logIn()
    >>> browser.open('http://localhost/subject/vu/mat_analize/file/7/get')
    Traceback (most recent call last):
    ...
    HTTPError: HTTP Error 404: Not Found

    >>> res = app.post("/group/moderators/js_create_folder",
    ...                params={'folder': 'Uga Buga',
    ...                        'section_id': '8'})
    >>> print dedent(res.body)
    <div class="target_item "><div class="upload target" id="file_upload_button-...">Uga Buga</div></div>
        <div class="folder_file_area subfolder click2show" id="file_area-...">
          <input class="folder_name" id="file_folder_name-..." type="hidden" value="Uga Buga" />
          <h4 class="">
            <span class="cont">
              Uga Buga
              <span class="small">(0 files)</span>
                <a  href="/group/moderators/delete_folder?folder=Uga+Buga" id="delete_folder_button-..." class="delete_folder_button">(Delete)</a>
            </span>
          </h4>
          <ul class="folder">
                <li class="message">There are no files here, this folder is empty!</li>
            </ul>
        </div>

Deleting folders:

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Folder to delete'},
    ...                upload_files=[("attachment", "image.png", "T")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/subject/vu/mat_analize/file/.../get">image.png</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder to delete'},
    ...                upload_files=[("attachment", "more_text.txt", "T")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/group/moderators/file/.../get">more_text.txt</a>
      ...
    </li>

    >>> res = app.post("/subject/vu/mat_analize/js_delete_folder",
    ...                params={'folder': 'Folder to delete'})
    >>> res.status
    '200 OK'

    >>> res = app.post("/group/moderators/js_delete_folder",
    ...                params={'folder': 'Also a folder to delete'})
    >>> res.status
    '200 OK'

Both folders should be gone:

    >>> browser = Browser.logIn()
    >>> browser.open('http://localhost/subject/vu/mat_analize')
    >>> browser.printQuery('id("mainContent")//h4')
    <h4 class="">
      <span class="cont">
                Buga Buga ...
      </span>
    </h4>
    <h4 class="">
      <span class="cont">
                Some folder ...
      </span>
    </h4>
    <h4 class="trash_heading">Trash</h4>

    >>> browser.open('http://localhost/group/moderators/files')
    >>> browser.printQuery('//h4')
    <h4 class="">
      <span class="cont">
                Also a folder ...
      </span>
    </h4>
    <h4 class="">
      <span class="cont">
                Uga Buga ...
      </span>
    </h4>
    <h4 class="trash_heading">Trash</h4>
    <h4>Moderatoriai</h4>

Deleting files:

    >>> app.get('/subject/vu/mat_analize/file/3/delete').status
    '200 OK'

    >>> app.get('/group/moderators/file/5/delete').status
    '200 OK'

    >>> app.get('/subject/vu/mat_analize/file/3/get', expect_errors=True).status
    '404 Not Found'

    >>> app.get('/group/moderators/file/5/get', expect_errors=True).status
    '404 Not Found'

Group payments:

Once the group's private files reach a limit, no more files can be uploaded.

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "more_text.txt", "12345678901234567890")])
    >>> print dedent(res.body)
    <li class="file">
      ...
      <a class="filename" href="/group/moderators/file/.../get">more_text.txt</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "over.txt", "over the limit")])
    >>> print dedent(res.body)
    UPLOAD_FAILED

    >>> res = app.post("/group/moderators/file_info",
    ...                params={'section_id': 0})
    >>> print res.body
    {"text": "\n  <div class=\"area_size\">free space: 0.0 b</div>\n", "image": "\n  <img alt=\"23.0 b\" class=\"area_size_points\" src=\"/images/details/pbar5.png\" />\n", "section_id": "0"}

The disabled upload control is shown with a message encouraging users to pay for the service.

    >>> browser.open('http://localhost/group/moderators/files')
    >>> browser.printQuery('//div[@class="upload_control no_upload "]')
    <div class="upload_control no_upload ">
      <table>
        <tr>
          <td>
            <div style="float: left;" class="btn inactive">
              <div>upload file to...</div>
            </div>
          </td>
          <td>
            <a style="float: left;" class="btn" href="/group/moderators/pay" title="Increase file area limits">
              <span>Increase limits</span>
            </a>
          </td>
        </tr>
      </table>
    </div>

    >>> browser.getLink('Increase limits').click()
    >>> browser.url
    'http://localhost/group/moderators/pay'

    >>> browser.getControl('10 Lt').click()
    >>> browser.url
    'http://localhost/pay'

    >>> cancel = browser.getLink('Go back').url
    >>> process = browser.getLink('Process payment').url
    >>> browser.getControl('Dummy pay 10 LTL').click()
    >>> browser.printQuery('//h2/text()')
    You have increased your group's file limit!

What if we had decided to cancel the payment?
    >>> browser.open(cancel)
    >>> browser.printQuery('//h1/text()')
    Moderatoriai
    You have decided not to increase your group's file limit

Anyway, let's process the payment:

    >>> browser.open(process)
    >>> print browser.contents
    OK

    >>> browser.open('http://localhost/group/moderators/files')

Once the group has been paid for and the payment has been processed,
uploading is enabled again:

    >>> browser.printQuery('//div[@class="upload_control no_upload "]')

    >>> browser.printQuery('//div[@class="show target_list file_upload_dropdown"]')
    <div class="show target_list file_upload_dropdown" id="file_upload_dropdown-0">
      <div class="target_item first">
        <div class="upload target" id="file_upload_button-0-0">Here</div>
      </div>
      <div class="target_item ">
        <div class="upload target" id="file_upload_button-0-1">Also a folder</div>
      </div>
      <div class="target_item last">
        <div class="upload target" id="file_upload_button-0-2">Uga Buga</div>
      </div>
    </div>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "over.txt", "over the limit")])
    >>> print dedent(res.body)
    <li class="file">
    ...
      <a class="filename" href="/group/moderators/file/12/get">over.txt</a>
    ...
    </li>

Oh, and since payments are not possible for the polish version, there is a page that explains it once the user has
clicked on the payment button.

    >>> import pylons.test
    >>> pylons.test.pylonsapp.config['tpl_lang'] = 'pl'

    >>> browser.open('http://localhost/group/moderators/pay')
    >>> browser.getLink('increase the limit').click()
    >>> browser.url
    'http://localhost/group/moderators/payment_deferred'

    >>> browser.open('http://localhost/group/moderators/payment_deferred')
    >>> browser.printQuery('//h1/text()')
    Moderatoriai
    Paying for the group is not possible at the moment
