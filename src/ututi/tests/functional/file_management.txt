Tests for ajax file management views
====================================

File upload:

    >>> from textwrap import dedent
    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "text.txt", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/1">text.txt</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Some folder'},
    ...                upload_files=[("attachment", "image.png", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/2">image.png</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "other_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/3">other_text.txt</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder'},
    ...                upload_files=[("attachment", "more_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/4">more_text.txt</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

Empty folder creation:

    >>> res = app.post("/subject/vu/mat_analize/create_folder",
    ...                params={'folder': 'Buga Buga',
    ...                        'section_id': '7'})
    >>> print dedent(res.body)
    <li class="alternative upload" id="file_upload_button-7-...">Buga Buga</li>
    <BLANKLINE>
    <div id="file_area-7-...">
      <input id="file_folder_name-7-..." type="hidden" value="Buga Buga" />
        <h4>
          <img src="/images/folder.png" />
          Buga Buga (<a href="">trinti</a>)
        </h4>
        <ul class="folder">
            <li class="message">There are no files here, this folder is empty!</li>
        </ul>
    </div>

    >>> res = app.post("/group/moderators/create_folder",
    ...                params={'folder': 'Uga Buga',
    ...                        'section_id': '8'})
    >>> print dedent(res.body)
    <li class="alternative upload" id="file_upload_button-8-...">Uga Buga</li>
    <BLANKLINE>
    <div id="file_area-8-...">
      <input id="file_folder_name-8-..." type="hidden" value="Uga Buga" />
        <h4>
          <img src="/images/folder.png" />
          Uga Buga (<a href="">trinti</a>)
        </h4>
        <ul class="folder">
            <li class="message">There are no files here, this folder is empty!</li>
        </ul>
    </div>

Deleting folders:

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Folder to delete'},
    ...                upload_files=[("attachment", "image.png", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/...">image.png</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder to delete'},
    ...                upload_files=[("attachment", "more_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/...">more_text.txt</a>
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/subject/vu/mat_analize/delete_folder",
    ...                params={'folder': 'Folder to delete'})
    >>> res.status
    '200 OK'

    >>> res = app.post("/group/moderators/delete_folder",
    ...                params={'folder': 'Also a folder to delete'})
    >>> res.status
    '200 OK'

Both folders should be gone:

    >>> browser = Browser()
    >>> browser.open('http://localhost/subject/vu/mat_analize')
    >>> browser.printQuery('//h4')

    # XXX subjects don't have their file listing working yet

    >>> browser.open('http://localhost/group/moderators/files')
    >>> browser.printQuery('//h4')
    <h4>Moderatoriai</h4>
    <h4>
      <img src="/images/folder.png" />
                Also a folder (<a href="">trinti</a>)
              </h4>
    <h4>
      <img src="/images/folder.png" />
                Uga Buga (<a href="">trinti</a>)
              </h4>

Deleting files:

    >>> app.get('/files/delete/1').status
    '200 OK'

    >>> app.get('/files/delete/3').status
    '200 OK'

    >>> app.get('/files/get/1', expect_errors=True).status
    '404 Not Found'

    >>> app.get('/files/get/3', expect_errors=True).status
    '404 Not Found'

    >>> app.post('/files/move/4',
    ...          params={'source-type': 'group',
    ...                  'source-id': 'moderators',
    ...                  'target-type': 'group',
    ...                  'target-id': 'moderators',
    ...                  'target-folder': 'Uga Buga'}).status
    '200 OK'

Moving files:

    >>> from ututi.tests.model.test_groups import printTree
    >>> from ututi.model import Group, LocationTag, Subject

    >>> printTree(Group.get('moderators'))
    Also a folder:
    Uga Buga:
       more_text.txt

    >>> app.post('/files/move/4',
    ...          params={'source-type': 'group',
    ...                  'source-id': 'moderators',
    ...                  'target-type': 'subject',
    ...                  'target-id': 'mat_analize',
    ...                  'target-tags': 'vu',
    ...                  'target-folder': 'Some folder'}).status
    '200 OK'

    >>> printTree(Group.get('moderators'))
    Also a folder:
    Uga Buga:

    >>> printTree(Subject.get(LocationTag.get(u'vu'), u'mat_analize'))
    Buga Buga:
    Some folder:
       image.png
       more_text.txt

    >>> app.post('/files/move/2',
    ...          params={'source-type': 'subject',
    ...                  'source-id': 'mat_analize',
    ...                  'source-tags': 'vu',
    ...                  'target-type': 'group',
    ...                  'target-id': 'moderators',
    ...                  'target-folder': ''}).status
    '200 OK'

    >>> printTree(Group.get('moderators'))
    image.png
    Also a folder:
    Uga Buga:

    >>> printTree(Subject.get(LocationTag.get(u'vu'), u'mat_analize'))
    Buga Buga:
    Some folder:
       more_text.txt

