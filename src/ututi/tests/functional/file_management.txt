Tests for ajax file management views
====================================

File upload:

    >>> res = app.post("/dologin",
    ...                params={'login': 'admin@ututi.lt', 'password': 'asdasd'})

    >>> from textwrap import dedent
    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "text.txt", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/3">text.txt</a>
      <input class="move_url" type="hidden" value="/files/move/3" />
      <input class="delete_url" type="hidden" value="/files/delete/3" />
      <img src="/images/delete.png" class="delete_button" />
    </li>

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Some folder'},
    ...                upload_files=[("attachment", "image.png", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/4">image.png</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': ''},
    ...                upload_files=[("attachment", "other_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/5">other_text.txt</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder'},
    ...                upload_files=[("attachment", "more_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/6">more_text.txt</a>
      ...
    </li>

Empty folder creation:

    >>> res = app.post("/subject/vu/mat_analize/create_folder",
    ...                params={'folder': 'Buga Buga',
    ...                        'section_id': '7'})
    >>> print dedent(res.body)
    <li class="alternative upload" id="file_upload_button-7-...">Buga Buga</li>
    <BLANKLINE>
    <div class="folder_file_area" id="file_area-7-...">
      <input class="folder_name" id="file_folder_name-7-..." type="hidden" value="Buga Buga" />
        <h4>
          <img src="/images/folder.png" />
          Buga Buga (<a href="#" id="delete_folder_button-7-..." class="delete_folder_button">Delete</a>)
        </h4>
        <ul class="folder">
            <li class="message">There are no files here, this folder is empty!</li>
        </ul>
    </div>

    >>> res = app.post("/group/moderators/create_folder",
    ...                params={'folder': 'Uga Buga',
    ...                        'section_id': '8'})
    >>> print dedent(res.body)
    <li class="alternative upload" id="file_upload_button-8-...">Uga Buga</li>
    <BLANKLINE>
    <div class="folder_file_area" id="file_area-8-...">
      <input class="folder_name" id="file_folder_name-8-..." type="hidden" value="Uga Buga" />
        <h4>
          <img src="/images/folder.png" />
          Uga Buga (<a href="#" id="delete_folder_button-8-..." class="delete_folder_button">Delete</a>)
        </h4>
        <ul class="folder">
            <li class="message">There are no files here, this folder is empty!</li>
        </ul>
    </div>

Deleting folders:

    >>> res = app.post("/subject/vu/mat_analize/upload_file",
    ...                params={'folder': 'Folder to delete'},
    ...                upload_files=[("attachment", "image.png", "Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/...">image.png</a>
      ...
    </li>

    >>> res = app.post("/group/moderators/upload_file",
    ...                params={'folder': 'Also a folder to delete'},
    ...                upload_files=[("attachment", "more_text.txt", "Test Test")])
    >>> print dedent(res.body)
    <li class="file">
      <img src="/images/mimetypes_icons/unknown.png" />
      <a href="/files/get/...">more_text.txt</a>
      ...
    </li>

    >>> res = app.post("/subject/vu/mat_analize/delete_folder",
    ...                params={'folder': 'Folder to delete'})
    >>> res.status
    '200 OK'

    >>> res = app.post("/group/moderators/delete_folder",
    ...                params={'folder': 'Also a folder to delete'})
    >>> res.status
    '200 OK'

Both folders should be gone:

    >>> browser = Browser()
    >>> browser.open('http://localhost/subject/vu/mat_analize')
    >>> browser.printQuery('//h4')
    <h4>
      <img src="/images/folder.png" />
                Buga Buga (...)
    </h4>
    <h4>
      <img src="/images/folder.png" />
                Some folder (...)
    </h4>

    >>> browser.open('http://localhost/group/moderators/files')
    >>> browser.printQuery('//h4')
    <h4>Moderatoriai</h4>
    <h4>
      <img src="/images/folder.png" />
                Also a folder (...)
    </h4>
    <h4>
      <img src="/images/folder.png" />
                Uga Buga (...)
    </h4>

Deleting files:

    >>> app.get('/files/delete/3').status
    '200 OK'

    >>> app.get('/files/delete/5').status
    '200 OK'

    >>> app.get('/files/get/3', expect_errors=True).status
    '404 Not Found'

    >>> app.get('/files/get/5', expect_errors=True).status
    '404 Not Found'

    >>> app.post('/files/move/6',
    ...          params={'source_type': 'group',
    ...                  'source_id': 'moderators',
    ...                  'target_type': 'group',
    ...                  'target_id': 'moderators',
    ...                  'target_folder': 'Uga Buga'}).status
    '200 OK'

Moving files:

    >>> from ututi.tests.model.test_groups import printTree
    >>> from ututi.model import Group, LocationTag, Subject

    >>> l1 = str(LocationTag.get(u'vu').id)

    >>> printTree(Group.get('moderators'))
    Also a folder:
    Uga Buga:
       more_text.txt

    >>> app.post('/files/move/6',
    ...          params={'source_type': 'group',
    ...                  'source_id': 'moderators',
    ...                  'target_type': 'subject',
    ...                  'target_id': 'mat_analize',
    ...                  'target_location': l1,
    ...                  'target_folder': 'Some folder'}).status
    '200 OK'

    >>> printTree(Group.get('moderators'))
    Also a folder:
    Uga Buga:

    >>> printTree(Subject.get(LocationTag.get(u'vu'), u'mat_analize'))
    Buga Buga:
    Some folder:
       image.png
       more_text.txt

    >>> app.post('/files/move/4',
    ...          params={'source_type': 'subject',
    ...                  'source_id': 'mat_analize',
    ...                  'source_location': l1,
    ...                  'target_type': 'group',
    ...                  'target_id': 'moderators',
    ...                  'target_folder': ''}).status
    '200 OK'

    >>> printTree(Group.get('moderators'))
    image.png
    Also a folder:
    Uga Buga:

    >>> printTree(Subject.get(LocationTag.get(u'vu'), u'mat_analize'))
    Buga Buga:
    Some folder:
       more_text.txt

