User registration flow
======================


A new Ututi user can start his registration on university page,
by clicking 'Register' button:

    >>> browser = Browser()
    >>> browser.open('http://localhost/')
    >>> browser.getLink('U-niversity').click()
    >>> browser.url
    'http://localhost/school/uni'

    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/registration/uni/start'

User has to type in a valid email address to initiate registration:

    >>> browser.getControl('Enter your email here:').value = 'what ever'
    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/registration/uni/start'
    >>> browser.printCssQuery('#registration_form .error-message', strip=True)
    <span>An email address must contain a single @</span>
    >>> browser.getControl('Enter your email here:').value = 'what ever@example.com'
    >>> browser.getControl('Register').click()
    >>> browser.printCssQuery('#registration_form .error-message', strip=True)
    <span>The username portion of the email address is invalid (the portion before the @: what ever)</span>

If user types in an existing email address, he will be redirected to login form:

    >>> browser.getControl('Enter your email here:').value = 'admin@uni.ututi.com'
    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/school/uni/login'

User come back to registration view ant types new email:

    >>> browser.open('http://localhost/registration/uni/start')
    >>> browser.getControl('Enter your email here:').value = 'user@example.com'
    >>> browser.getControl('Register').click()

A confirmation code is sent to user's email, and the page states so:

    >>> browser.printCssQuery('h2', strip=True)
    <h2>Email approval</h2>

    >>> browser.printCssQuery('#confirmation-instruction', strip=True)
    <div>
        <p>We need to approve that you are the owner of this email address.
        You have received a confirmation code to user@example.com.</p>
        <p>Did not get the confirmation code? Press "Send again" button.</p>
    </div>

User can click the "Send again" button, and the code is sent again:

    >>> browser.getControl("Send again").click()
    >>> browser.url
    'http://localhost/registration/resend'

    >>> browser.printCssQuery('h2', strip=True)
    <h2>Email approval</h2>

The same thing happens if the user simply restarts the registration process:

    >>> browser.open('http://localhost/registration/uni/start')
    >>> browser.getControl('Enter your email here:').value = 'user@example.com'
    >>> browser.getControl('Register').click()
    >>> browser.printCssQuery('h2', strip=True)
    <h2>Email approval</h2>

Let's check the emails:

    >>> from ututi.lib.mailer import mail_queue

    >>> len(mail_queue)
    3

    >>> msg1, msg2, msg3 = mail_queue
    >>> msg1.payload() == msg2.payload() == msg3.payload()
    True

    >>> print msg1.payload()
    We have received a request to confirm the ownership of this email on the Ututi system.
    If this email belongs to you, confirm it by clicking on this link:
    http://localhost/registration/approve/...
    Ututi team

    >>> msg1.recipients
    ['user@example.com']

    >>> mail_queue[:] = []

When user clicks on confirmation link, he starts his registration process:

    >>> from ututi.lib.helpers import get_urls
    >>> urls = get_urls(msg1.payload())
    >>> browser = Browser()
    >>> browser.open(urls[0])
