User registration flow
======================


A new Ututi user can start his registration on university page,
by clicking 'Register' button:

    >>> browser = Browser()
    >>> browser.open('http://localhost/')
    >>> browser.getLink('U-niversity').click()
    >>> browser.url
    'http://localhost/school/uni'

    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/registration/uni/start'

User has to type in a valid email address to initiate registration:

    >>> browser.getControl('Enter your email here:').value = 'what ever'
    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/registration/uni/start'
    >>> browser.printCssQuery('#registration_form .error-message', strip=True)
    <span>An email address must contain a single @</span>
    >>> browser.getControl('Enter your email here:').value = 'what ever@example.com'
    >>> browser.getControl('Register').click()
    >>> browser.printCssQuery('#registration_form .error-message', strip=True)
    <span>The username portion of the email address is invalid (the portion before the @: what ever)</span>

If user types in an existing email address, he will be redirected to login form:

    >>> browser.getControl('Enter your email here:').value = 'admin@uni.ututi.com'
    >>> browser.getControl('Register').click()
    >>> browser.url
    'http://localhost/school/uni/login'

Regression test: non-ascii characters in email are not valid in Ututi:

    >>> browser.open('http://localhost/registration/uni/start')
    >>> browser.getControl('Enter your email here:').value = u'\u016bser@example.com'.encode('utf-8')
    >>> browser.getControl('Register').click()
    >>> browser.printCssQuery('.error-message', strip=True)
    <span>Email address cannot contain unicode characters</span>

User come back to registration view ant types new email:

    >>> browser.getControl('Enter your email here:').value = 'user@example.com'
    >>> browser.getControl('Register').click()

A confirmation code is sent to user's email, and the page states so:

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Email approval</h1>

    >>> browser.printCssQuery('#confirmation-instruction', strip=True)
    <div>
        <p>We need to approve that you are the owner of this email address.
        You have received a confirmation code to user@example.com.</p>
        <p>Did not get the confirmation code? Press "Send again" button.</p>
    </div>

User can click the "Send again" button, and the code is sent again:

    >>> browser.getControl("Send again").click()
    >>> browser.url
    'http://localhost/registration/resend'

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Email approval</h1>

A flash message is displayed:

    >>> browser.printQuery("//div[@class='flash-message']//text()")
    Your confirmation code was resent.

The same thing happens if the user simply restarts the registration process:

    >>> browser.open('http://localhost/registration/uni/start')
    >>> browser.getControl('Enter your email here:').value = 'user@example.com'
    >>> browser.getControl('Register').click()
    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Email approval</h1>

But no flash message here:

    >>> browser.printQuery("//div[@class='flash-message']//text()")

Let's check the emails:

    >>> from ututi.lib.mailer import mail_queue

    >>> len(mail_queue)
    3

    >>> msg1, msg2, msg3 = mail_queue
    >>> msg1.payload() == msg2.payload() == msg3.payload()
    True

    >>> print msg1.payload()
    We have received a request to confirm the ownership of this email on the Ututi system.
    If this email belongs to you, confirm it by clicking on this link:
    http://localhost/registration/.../confirm
    Ututi team

    >>> msg1.recipients
    ['user@example.com']

    >>> mail_queue[:] = []

When user clicks on confirmation link, he starts his registration process:

    >>> from ututi.lib.helpers import get_urls
    >>> urls = get_urls(msg1.payload())
    >>> browser.open(urls[0])

The first registration step is "University information" step:

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>University information</h1>

It displays some people from this university:

    >>> browser.printCssQuery('#people-box .name', strip=True)
    <td> <a>Adminas Adminovix</a> </td>
    <td> <a>Benas</a> </td>
    <td> <a>Second user</a> </td>
    <td> <a>Third user</a> </td>
    <td> <a>Alternative user</a> </td>


TODO: the "Contact us" link does not take us anywhere yet:
(Also this test exposes a bug of css selector.)

    >>> browser.printCssQuery('a#contact-link')
    <a href="#" id="contact-link">Contact us</a>.

The "Next" takes user to "Personal information" step:

    >>> browser.getControl("Next").click()
    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Personal information</h1>

Before going next, user has to fill in his full name and password:

    >>> browser.getControl("Next").click()
    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Personal information</h1>

    >>> browser.printCssQuery('.error-message', strip=True)
    <span>Please enter your password.</span>
    <span>Please enter your full name.</span>

    >>> form = browser.getForm('personal-info-form')
    >>> form.getControl('Full name:').value = 'User'
    >>> form.getControl('Password:').value = 'password'
    >>> form.getControl('Next').click()

This takes user to the third step: "Add your photo":

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Add your photo</h1>

Adding photo is mandatory:

    >>> browser.getLink('Skip').click()
    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Invite friends</h1>

However, the 'Next' button raises an error:

    >>> browser.goBack()

    >>> browser.getControl('Next').click()
    >>> browser.printCssQuery('.error-message', strip=True)
    <span>Please select your photo.</span>

Personally, I think this is a bug and there should be only one button.

Let's upload the photo:

    >>> from ututi.tests.functional import make_file
    >>> form = browser.getForm('add-photo-form')
    >>> form.getControl(name='photo').add_file(*make_file('test_logo.png'))
    >>> browser.getControl('Next').click()

This automatically takes user to the next step:

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Invite friends</h1>

User can enter 0 to 5 emails. The suffix is automatically added and
is the same as this user's. Emails are validated properly:

    >>> form = browser.getForm('invite-friends-form')
    >>> form.getControl(name='email1').value = 'one'
    >>> form.getControl(name='email2').value = 't w o'
    >>> form.getControl(name='email3').value = 'three'
    >>> form.getControl(name='email4').value = '     '
    >>> form.getControl(name='email5').value = 'fi@ve'
    >>> browser.getControl('Finish').click()

    >>> browser.printCssQuery('.error-message', strip=True)
    <span>The username portion of the email address is invalid (the portion before the @: t w o)</span>
    <span>The domain portion of the email address is invalid (the portion after the @: ve@example.com)</span>

    >>> form = browser.getForm('invite-friends-form')
    >>> form.getControl(name='email1').value
    'one'
    >>> form.getControl(name='email2').value
    't w o'
    >>> form.getControl(name='email3').value
    'three'
    >>> form.getControl(name='email4').value
    '     '
    >>> form.getControl(name='email5').value
    'fi@ve'

If correct email addresses are submitted, user is taken to the "Welcome" page,
and invitation are sent:

    >>> form.getControl(name='email2').value = 'two'
    >>> form.getControl(name='email5').value = 'five'
    >>> browser.getControl('Finish').click()

    >>> browser.printCssQuery('h1.page-title', strip=True)
    <h1>Welcome to Ututi!</h1>

    >>> len(mail_queue)
    4

A flash message is displayed, indicating that emails were sent.

    >>> browser.printQuery("//div[@class='flash-message']//text()")
    Invitations sent to one@example.com, two@example.com, three@example.com, five@example.com

    >>> [msg.recipients for msg in mail_queue]
    [['one@example.com'], ['two@example.com'], ['three@example.com'], ['five@example.com']]

    >>> mail_queue[:] = []
