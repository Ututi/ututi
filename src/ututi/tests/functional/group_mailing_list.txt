Test for group mailing list UI
==============================

    >>> browser = Browser.logIn()

    >>> browser.getLink('Moderatoriai').click()
    >>> browser.getLink('Forum').click()

There are no threads posted at the moment:

    >>> browser.printQuery("id('forum-thread-list')")
    <table id="forum-thread-list">
      <tr>
        <th>Subject</th>
        <th>Replies</th>
        <th>Last post</th>
      </tr>
    </table>

Let's send some messages:

    >>> from ututi.tests.functional import send_test_message
    >>> send_test_message('simple_email.txt', '1', to='moderators@lists.ututi.lt')
    >>> send_test_message('simple_email.txt', '2', to='moderators@lists.ututi.lt', reply_to='1')
    >>> send_test_message('simple_email.txt', '3', to='moderators@lists.ututi.lt', reply_to='1')
    >>> send_test_message('email_with_attachment.txt', '4', to='moderators@lists.ututi.lt', reply_to='2')

And verify that they got properly processed by our email handler:

    >>> from ututi.model.mailing import GroupMailingListMessage
    >>> from ututi.model import meta

    >>> [msg1, msg2, msg3, msg4] = meta.Session.query(GroupMailingListMessage).all()

    >>> msg1.replies == [msg2, msg3]
    True
    >>> msg2.reply_to is msg1
    True
    >>> msg3.reply_to is msg1
    True

    >>> msg2.thread is msg1
    True
    >>> msg3.thread is msg1
    True
    >>> msg4.thread is msg1
    True
    >>> msg1.thread is msg1
    True

    >>> msg1.posts == [msg1, msg2, msg3, msg4]
    True

Data structures seem to be ok, let's see if they are displayed
properly in the forum page:

    >>> browser.open('http://localhost/group/moderators/forum')
    >>> browser.printQuery("id('forum-thread-list')")
    <table id="forum-thread-list">
      <tr>
        <th>Subject</th>
        <th>Replies</th>
        <th>Last post</th>
      </tr>
      <tr>
        <td class="subject">
          <a href="/group/moderators/forum/thread/3">Hello</a>
        </td>
        <td class="count">3</td>
        <td class="author">
          <a class="profile-link" href="/user/1">Adminas Adminovix</a>
          <br />
          <span class="date">2009.06.15 14:55</span>
        </td>
      </tr>
    </table>

Let's look at the attachment in the thread:

    >>> browser.getLink('Hello').click()
    >>> browser.getLink('README.txt')
    <Link text='README.txt' url='http://localhost/group/moderators/forum/file/6/7'>

    >>> browser.getLink('Forum').click()

Let's post a new topic now:

    >>> browser.getLink('Post new topic').click()

    >>> browser.url
    'http://localhost/group/moderators/forum/new_thread'

    >>> browser.getControl('Subject').value = "Hi mom"
    >>> browser.getControl('Message').value = u"I am doing fine. Send more cash."
    >>> browser.getControl('Post').click()

The email gets sent to all the members of the group:

    >>> from ututi.lib.mailer import mail_queue
    >>> msg = mail_queue.pop()
    >>> print msg.message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: admin@ututi.lt
    To: moderators@lists.ututi.lt
    Subject: Hi mom
    Message-ID: <...@lists.ututi.lt>
    <BLANKLINE>
    I am doing fine. Send more cash.

    >>> msg.recipients
    ['admin@ututi.lt']

And we get redirected to our newly created thread

    >>> browser.url
    'http://localhost/group/moderators/forum/thread/8'

    >>> browser.printQuery("id('page-content')//div[@class='thread-post']")
    <div class="thread-post">
      <div class="post-title">Adminas Adminovix -- Hi mom</div>
      <pre class="post-body">
        I am doing fine. Send more cash.
      </pre>
    </div>

If we go back to the forum, we should see the new thread in the list
of threads:

    >>> browser.getLink('Forum').click()
    >>> browser.printQuery("id('forum-thread-list')")
    <table id="forum-thread-list">
      <tr>
        <th>Subject</th>
        <th>Replies</th>
        <th>Last post</th>
      </tr>
      <tr>
        <td class="subject">
          <a href="/group/moderators/forum/thread/8">Hi mom</a>
        </td>
        <td class="count">0</td>
        <td class="author">
          <a class="profile-link" href="/user/1">Adminas Adminovix</a>
          <br />
          <span class="date">...</span>
        </td>
      </tr>
      <tr>
        <td class="subject">
          <a href="/group/moderators/forum/thread/3">Hello</a>
        </td>
        <td class="count">3</td>
        <td class="author">
          <a class="profile-link" href="/user/1">Adminas Adminovix</a>
          <br />
          <span class="date">2009.06.15 14:55</span>
        </td>
      </tr>
    </table>

Let's go back to it now, and post a reply:

    >>> browser.getLink('Hi mom').click()
    >>> browser.getControl('Message').value = "Oh, and don't forget to feed the fish!"
    >>> browser.getControl('Reply').click()

The email gets sent.

    >>> from ututi.lib.mailer import mail_queue
    >>> print mail_queue.pop().message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: admin@ututi.lt
    To: moderators@lists.ututi.lt
    Subject: Re: Hi mom
    Message-ID: <...@lists.ututi.lt>
    In-reply-to: <...@lists.ututi.lt>
    <BLANKLINE>
    Oh, and don't forget to feed the fish!

We still should be looking at the thread:

    >>> browser.url
    'http://localhost/group/moderators/forum/thread/8'

And our new message should be in the list:

    >>> browser.printQuery("id('page-content')//div[@class='thread-post']")
    <div class="thread-post">
      <div class="post-title">Adminas Adminovix -- Hi mom</div>
      <pre class="post-body">
        I am doing fine. Send more cash.
      </pre>
    </div>
    <div class="thread-post">
      <div class="post-title">Adminas Adminovix -- Re: Hi mom</div>
      <pre class="post-body">
        Oh, and don't forget to feed the fish!
      </pre>
    </div>

If there is more than one member in the group, all of them get the
email:

    >>> from ututi.model import Group, User, meta
    >>> group = Group.get('moderators')
    >>> user = User.get('user@ututi.lt')
    >>> group.add_member(user)
    >>> meta.Session.commit()

    >>> browser.getControl('Message').value = "Let's welcome our new member!"
    >>> browser.getControl('Reply').click()

    >>> msg = mail_queue.pop()
    >>> print msg.message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: admin@ututi.lt
    To: moderators@lists.ututi.lt
    Subject: Re: Hi mom
    Message-ID: <...@lists.ututi.lt>
    In-reply-to: <...@lists.ututi.lt>
    <BLANKLINE>
    Let's welcome our new member!

    >>> msg.recipients
    ['admin@ututi.lt', 'user@ututi.lt']

And clean up the email queue:

    >>> len(mail_queue)
    4
    >>> mail_queue[:] = []
