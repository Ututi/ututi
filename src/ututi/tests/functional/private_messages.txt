Private messages
================

Users can send each other private messages.

    >>> browser = Browser.logIn('user@ututi.lt', 'password')

Initially the inbox is empty:

    >>> browser.printQuery("id('inbox-link')")
    <a id="inbox-link" href="/messages">Private messages</a>

Sending messages
----------------

Let's send a message:

    >>> browser.open('http://localhost/user/3')
    >>> browser.click('Send private message')

    >>> browser.getControl('Subject').value = 'First message'
    >>> browser.getControl('Message').value = 'First!'
    >>> browser.getControl('Post').click()

    >>> browser.printQuery("//div[@class='flash-message']/span/text()")
    Message sent.

Receiving messages
------------------

The other user should have received the message

    >>> browser2 = Browser.logIn('user2@ututi.lt', 'password')
    >>> browser2.printQuery("id('inbox-link')")
    <a id="inbox-link" href="/messages">
      <strong>Private messages (1)</strong>
    </a>

    >>> browser2.getLink('Private messages (1)').click()
    >>> browser2.getLink('First message').click()

    >>> browser2.printQuery("//div[@class='post-body']/text()")
    First!

There are no unread messages any more:

    >>> browser2.getLink('Home').click()
    >>> browser2.printQuery("id('inbox-link')")
    <a id="inbox-link" href="/messages">Private messages</a>

Replying
--------

Let's go to first message and reply:

    >>> browser2.getLink('Private messages').click()
    >>> browser2.getLink('First message').click()
    >>> form = browser2.getForm(id='message_form')
    >>> form.getControl(name='message').value = 'Second!'
    >>> form.getControl('Reply').click()

We can see both messages in a thread:

    >>> browser2.printQuery("//div[@class='post-body']/text()")
    First!
    Second!

The first user can see the reply:

    >>> browser = Browser.logIn('user@ututi.lt', 'password')
    >>> browser.getLink('Private messages (1)').click()
    >>> browser.getLink('First message').click()
    >>> browser.printQuery("//div[@class='post-body']/text()")
    First!
    Second!

    >>> browser.getLink('Back to message list').click()

Mark all messages as read
-------------------------

If you have several unread messages, you can mark them as read in one fell
swoop.  Let's add a message:

    >>> form = browser2.getForm(id='message_form')
    >>> form.getControl(name='message').value = 'Third!'
    >>> form.getControl('Reply').click()

There's one unread message:

    >>> browser.reload()
    >>> browser.printQuery("id('inbox-link')")
    <a id="inbox-link" href="/messages">
      <strong>Private messages (1)</strong>
    </a>

We can mark it as read:

    >>> browser.getLink('Private messages (1)').click()
    >>> browser.getControl('Mark all as read').click()

There are no unread messages now:

    >>> browser.reload()
    >>> browser.printQuery("id('inbox-link')")
    <a id="inbox-link" href="/messages">Private messages</a>

Delete
------

Threads can be deleted.

    >>> browser.getLink('Private messages').click()
    >>> browser.printQuery("//a[@class='post-title']/text()")
    First message
    >>> browser.getControl('Delete').click()
    >>> browser.printQuery("//a[@class='post-title']/text()")

However, if the peer sends another message, the thread reappears:

    >>> browser2.getLink('Private messages').click()
    >>> browser2.getLink('First message').click()
    >>> form = browser2.getForm(id='message_form')
    >>> form.getControl(name='message').value = 'Frankenstein!'
    >>> form.getControl('Reply').click()

    >>> browser.getLink('Private messages').click()
    >>> browser.printQuery("//a[@class='post-title']/text()")
    First message

Deletion by recipient is independent from deletion by sender:

    >>> browser.getControl('Delete').click()

    >>> browser2.getLink('Private messages').click()
    >>> browser2.printQuery("//a[@class='post-title']/text()")
    First message
    >>> browser2.getControl('Delete').click()
    >>> browser2.printQuery("//a[@class='post-title']/text()")

Private messages sent to self can be deleted too:

    >>> browser2.open('http://localhost/user/3')
    >>> browser2.click('Send private message')
    >>> browser2.getControl('Subject').value = 'Alter ego'
    >>> browser2.getControl('Message').value = 'Talking to myself.'
    >>> browser2.getControl('Post').click()

    >>> browser2.getLink('Home').click()
    >>> browser2.getLink('Private messages').click()
    >>> browser2.printQuery("//a[@class='post-title']/text()")
    Alter ego
    >>> browser2.getControl('Delete').click()
    >>> browser2.printQuery("//a[@class='post-title']/text()")

The deleted message was marked as read:

    >>> browser2.getLink('Private messages')
    <Link text='Private messages' url='http://localhost/messages'>

