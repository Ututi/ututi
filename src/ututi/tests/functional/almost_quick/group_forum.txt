Group forums
============

First of all let's log in;

    >>> browser = Browser.logIn()

Let's find the group:

    >>> browser.open('http://localhost/group/moderators')
    >>> browser.url
    'http://localhost/group/moderators/home'

    >>> browser.getLink('Edit').click()

    >>> browser.getControl('Forum type').value = ['forum']
    >>> browser.getControl('Save').click()

    >>> browser.url
    'http://localhost/group/moderators/home'

(Regression test: the user's home page does not fail before we visit the forum.)

    >>> browser2 = Browser.logIn()

Let's enter the forum:

    >>> browser.open('http://localhost/group/moderators/forum')

There should be a default category, 'General':

    >>> browser.getLink('General').click()

Let's start a thread:

    >>> browser.getControl('New topic').click()
    >>> form = browser.getForm(id='group_add_form')
    >>> form.getControl(name='title').value = "What's up?"
    >>> form.getControl(name='message').value = "How's everybody doin'?"
    >>> form.getControl('Post').click()

Let's post a reply:
    >>> browser2 = Browser.logIn('user3@ututi.lt', 'password')
    >>> browser2.getLink('Moderatoriai', url='/group/moderators').click()
    >>> browser2.open('http://localhost/group/moderators/forum')
    >>> browser2.getLink("What's up?").click()
    >>> browser2.getControl('Message').value = 'Not too bad'
    >>> browser2.getControl('Reply', index=1).click()

A notification to subscribed group members has been sent by email:
    >>> from ututi.lib.mailer import mail_queue
    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@uni.ututi.com']
    >>> print msg.payload()
    Third user posted on the 'Moderatoriai' forum:
    <BLANKLINE>
    Not too bad
    <BLANKLINE>
    --
    You can find the thread online here:
    http://localhost/group/moderators/forum/3/thread/4
    <BLANKLINE>
    The Ututi team

And we'll post a reply:

    >>> form = browser.getForm(id='forum_reply_form')
    >>> form.getControl(name='message').value = 'Not too bad!'
    >>> browser.getForm(id="forum_reply_form").submit()

We can see the messages we posted:

    >>> browser.printQuery('//div[@class="post-body"]')
    <div class="post-body">How's everybody doin'?</div>
    <div class="post-body">Not too bad</div>
    <div class="post-body">Not too bad!</div>

Let's go back to the topic list.

    >>> browser.getLink('Back to the topic list').click()

    >>> browser.printQuery('//a[@class="post-title"]')
    <a href="/group/moderators/forum/.../thread/..." class="post-title">What's up?</a>

And all the way up to the category list:

    >>> browser.getLink('Back to category list').click()

    >>> browser.printQuery('id("main-content")//h2/a')
    <a href="/group/moderators/forum/..." class="grey">General</a>
    <a class="edit-category" href="/group/moderators/forum/.../edit">Edit category</a>



Email subscriptions
===================

Let's invite a few more members for testing:

    >>> browser.open('http://localhost/group/moderators/members')
    >>> emails = 'user@ututi.lt, user2@ututi.lt'
    >>> form = browser.getForm(id='member_invitation_form')
    >>> form.getControl(name='emails').value = emails
    >>> form.getControl('Invite').click()

Drop the email invitations, those are not interesting:

    >>> del mail_queue[:]

Excellent. Now log in as one of the users:

    >>> user = Browser.logIn('user@ututi.lt', 'password')

Accept the group invitation

    >>> user.getControl('Accept').click()
    >>> user.getLink('Moderatoriai', url='/group/moderators').click()
    >>> user.open('http://localhost/group/moderators/forum')

We see the thread the admin has posted:

    >>> user.printQuery('//a[@class="post-title"]')
    <a href="/group/moderators/forum/.../thread/..." class="post-title">What's up?</a>

Let's look into it:

    >>> user.getLink("What's up?").click()

We could subscribe to email updates:

    >>> user.getControl('Subscribe to emails')
    <SubmitControl name=None type='submitbutton'>

Let's post a reply:

    >>> form = user.getForm(id='forum_reply_form')
    >>> form.getControl(name='message').value = 'I agree!'
    >>> user.getForm(id="forum_reply_form").submit()

By the act of replying, we were automatically subscribed:

    >>> user.getControl('Unsubscribe from emails')
    <SubmitControl name=None type='submitbutton'>

The resulting email notification was sent to the admin user and not to us:

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@uni.ututi.com']

Now, if, say, the admin posts a message, we will receive an email:

    >>> browser.open('http://localhost/group/moderators/forum')
    >>> browser.getLink("What's up?").click()
    >>> form = browser.getForm(id='forum_reply_form')
    >>> form.getControl(name='message').value = 'Indeed!'
    >>> browser.getForm(id="forum_reply_form").submit()

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['user@ututi.lt']

Let's unsubscribe from emails.

    >>> user.getControl('Unsubscribe from emails').click()

Now any further replies will not be sent to us.

    >>> form = user.getForm(id='forum_reply_form')
    >>> form.getControl(name='message').value = 'Right!'
    >>> user.getForm(id="forum_reply_form").submit()

    >>> mail_queue.pop()
    <EmailInfo sender='info@ututi.lt' recipients=['admin@uni.ututi.com']>

Since we unsubscribed explicitly, we will not be automatically resubscribed
again:

    >>> user.getControl('Subscribe to emails')
    <SubmitControl name=None type='submitbutton'>

