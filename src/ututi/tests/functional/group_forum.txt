Group forums
============

First of all let's log in;

    >>> browser = Browser.logIn()

Let's find the group:

    >>> browser.open('http://localhost/group/moderators')
    >>> browser.url
    'http://localhost/group/moderators/home'

    >>> browser.getLink('Edit').click()

    >>> browser.getControl('Forum type').value = ['forum']
    >>> browser.getControl('Save').click()

    >>> browser.url
    'http://localhost/group/moderators/home'

Let's enter the forum:

    >>> browser.getLink('Forum').click()

There should be a default category, 'General':

    >>> browser.getLink('General').click()

Let's start a thread:

    >>> browser.getLink('New topic').click()
    >>> browser.getControl(name='title').value = "What's up?"
    >>> browser.getControl(name='message').value = "How's everybody doin'?"
    >>> browser.getControl('Post').click()

A notification to subscribed group members has been sent by email:

    >>> from ututi.lib.mailer import mail_queue
    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@ututi.lt']
    >>> print msg.message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: info@ututi.lt
    Subject: [moderators] What's up?
    Message-ID: <...>
    <BLANKLINE>
    Adminas Adminovix posted on the 'Moderatoriai' forum:
    <BLANKLINE>
    How's everybody doin'?
    <BLANKLINE>
    --
    You can find the thread online here:
    http://localhost/group/moderators/forum/3/thread/3
    <BLANKLINE>
    The Ututi team
    <BLANKLINE>

And we'll post a reply:

    >>> browser.getControl(name='message').value = 'Not too bad!'
    >>> browser.getControl('Reply').click()

Email notifications about the reply have also been sent:

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@ututi.lt']
    >>> print msg.message
    MIME-Version: 1.0
    Content-Type: text/plain; charset="us-ascii"
    Content-Transfer-Encoding: 7bit
    From: info@ututi.lt
    To: info@ututi.lt
    Subject: [moderators] Re: What's up?
    Message-ID: <...>
    <BLANKLINE>
    Adminas Adminovix posted on the 'Moderatoriai' forum:
    <BLANKLINE>
    Not too bad!
    <BLANKLINE>
    --
    You can find the thread online here:
    http://localhost/group/moderators/forum/3/thread/3
    <BLANKLINE>
    The Ututi team
    <BLANKLINE>

We can see the messages we posted:

    >>> browser.printQuery('//div[@class="post-body"]')
    <div class="post-body">
            How's everybody doin'?
          </div>
    <div class="post-body">
            Not too bad!
          </div>

Let's go back to the topic list.

    >>> browser.getLink('Back to the topic list').click()

    >>> browser.printQuery('//td[@class="subject"]')
    <td class="subject">
      <a class="thread-subject" href="/group/moderators/forum/3/thread/3">What's up?</a>
    </td>

And all the way up to the category list:

    >>> browser.getLink('Back to category list').click()

    >>> browser.printQuery('//h2[@class="category"]')
    <h2 class="category">
      <a href="/group/moderators/forum/3">General</a>
    </h2>


Email subscriptions
===================

Let's invite a few more members for testing:

    >>> browser.open('http://localhost/group/moderators/members')
    >>> browser.getControl('Enter emails of the people you would like to'
    ... ' invite to the group.').value = 'user@ututi.lt, user2@ututi.lt'
    >>> browser.getControl('Invite').click()

Drop the email invitations, those are not interesting:

    >>> del mail_queue[:]

Excellent. Now log in as one of the users:

    >>> ubrowser = Browser.logIn('user@ututi.lt', 'password')

Accept the group invitation

    >>> ubrowser.getControl('Accept').click()
    >>> ubrowser.getLink('Moderatoriai').click()
    >>> ubrowser.getLink('Forum').click()

We see the thread the admin has posted:

    >>> ubrowser.printQuery('//td[@class="subject"]')
    <td class="subject">
      <a href="/group/moderators/forum/3/thread/3#unseen">
                [N]
              </a>
      <a class="thread-subject unread" href="/group/moderators/forum/3/thread/3">What's up?</a>
    </td>

Let's look into it:

    >>> ubrowser.getLink("What's up?").click()

We could subscribe to email updates:

    >>> ubrowser.getControl('Subscribe to emails')
    <SubmitControl name=None type='submit'>

Let's post a reply:

    >>> ubrowser.getControl(name='message').value = 'I agree!'
    >>> ubrowser.getControl('Reply').click()

By the act of replying, we were automatically subscribed:

    >>> ubrowser.getControl('Unsubscribe from emails')
    <SubmitControl name=None type='submit'>

The resulting email notification was sent to the admin user and to us:

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['user@ututi.lt', 'admin@ututi.lt']

Now, if, say, the admin posts a message, we will receive an email:

    >>> browser.getLink('Forum').click()
    >>> browser.getLink("What's up?").click()
    >>> browser.getControl(name='message').value = 'Indeed!'
    >>> browser.getControl('Reply').click()

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['user@ututi.lt', 'admin@ututi.lt']

Let's unsubscribe from emails.

    >>> ubrowser.getControl('Unsubscribe from emails').click()

Now any further replies will not be sent to us.

    >>> ubrowser.getControl(name='message').value = 'Right!'
    >>> ubrowser.getControl('Reply').click()

    >>> mail_queue.pop()
    <EmailInfo sender='info@ututi.lt' recipients=['admin@ututi.lt']>

Since we unsubscribed explicitly, we will not be automatically resubscribed
again:

    >>> ubrowser.getControl('Subscribe to emails')
    <SubmitControl name=None type='submit'>

Forum-wide subscriptions
========================

We can subscribe to the entire forum. Then we will be automatically
subscribed to any new threads:

    >>> ubrowser.getLink('Back to the topic list').click()
    >>> ubrowser.getLink('Get email').click()

Now, the admin creates another thread:

    >>> browser.getLink('Back to the topic list').click()

    >>> browser.getLink('New topic').click()
    >>> browser.getControl(name='title').value = "Some news"
    >>> browser.getControl(name='message').value = "Notice this?"
    >>> browser.getControl('Post').click()

And the user is automatically subscribed to it:

    >>> mail_queue.pop()
    <EmailInfo sender='info@ututi.lt' recipients=['user@ututi.lt', 'admin@ututi.lt']>
