Group forums
============

First of all let's log in;

    >>> browser = Browser.logIn()

Let's find the group:

    >>> browser.open('http://localhost/group/moderators')
    >>> browser.url
    'http://localhost/group/moderators/home'

    >>> browser.getLink('Edit').click()

    >>> browser.getControl('Forum type').value = ['forum']
    >>> browser.getControl('Save').click()

    >>> browser.url
    'http://localhost/group/moderators/home'

(Regression test: the user's home page does not fail before we visit the forum.)

    >>> browser2 = Browser.logIn()

Let's enter the forum:

    >>> browser.getLink('Forum').click()

There should be a default category, 'General':

    >>> browser.getLink('General').click()

Let's start a thread:

    >>> browser.getControl('New topic').click()
    >>> browser.getControl(name='title').value = "What's up?"
    >>> browser.getControl(name='message').value = "How's everybody doin'?"
    >>> browser.getControl('Post').click()

Let's post a reply:
    >>> browser2 = Browser.logIn('user3@ututi.lt', 'password')
    >>> browser2.getLink('Moderatoriai').click()
    >>> browser2.getLink('Forum').click()
    >>> browser2.getLink("What's up?").click()
    >>> browser2.getControl('Message').value = 'Not too bad'
    >>> browser2.getControl('Reply', index=1).click()

A notification to subscribed group members has been sent by email:
    >>> from ututi.lib.mailer import mail_queue
    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@ututi.lt']
    >>> print msg.payload()
    Third user posted on the 'Moderatoriai' forum:
    <BLANKLINE>
    Not too bad
    <BLANKLINE>
    --
    You can find the thread online here:
    http://localhost/group/moderators/forum/3/thread/4
    <BLANKLINE>
    The Ututi team

And we'll post a reply:

    >>> browser.getControl(name='message').value = 'Not too bad!'
    >>> browser.getForm(id="forum_reply_form").submit()

We can see the messages we posted:

    >>> browser.printQuery('//div[@class="post-body"]')
    <div class="post-body">How's everybody doin'?</div>
    <div class="post-body">Not too bad</div>
    <div class="post-body">Not too bad!</div>

Let's go back to the topic list.

    >>> browser.getLink('Back to the topic list').click()

    >>> browser.printQuery('//a[@class="post-title"]')
    <a href="/group/moderators/forum/.../thread/..." class="post-title">What's up?</a>

And all the way up to the category list:

    >>> browser.getLink('Back to category list').click()

    >>> browser.printQuery('id("mainContent")//h2/a')
    <a href="/group/moderators/forum/..." class="grey">General</a>
    <a class="edit-category" href="/group/moderators/forum/.../edit">Edit category</a>



Email subscriptions
===================

Let's invite a few more members for testing:

    >>> browser.open('http://localhost/group/moderators/members')
    >>> emails = 'user@ututi.lt, user2@ututi.lt'
    >>> browser.getControl(name='emails').value = emails
    >>> browser.getControl('Invite').click()

Drop the email invitations, those are not interesting:

    >>> del mail_queue[:]

Excellent. Now log in as one of the users:

    >>> ubrowser = Browser.logIn('user@ututi.lt', 'password')

Accept the group invitation

    >>> ubrowser.getControl('Accept').click()
    >>> ubrowser.getLink('Moderatoriai').click()
    >>> ubrowser.getLink('Forum').click()

We see the thread the admin has posted:

    >>> ubrowser.printQuery('//a[@class="post-title"]')
    <a href="/group/moderators/forum/.../thread/..." class="post-title">What's up?</a>

Let's look into it:

    >>> ubrowser.getLink("What's up?").click()

We could subscribe to email updates:

    >>> ubrowser.getControl('Subscribe to emails')
    <SubmitControl name=None type='submitbutton'>

Let's post a reply:

    >>> ubrowser.getControl(name='message').value = 'I agree!'
    >>> ubrowser.getForm(id="forum_reply_form").submit()

By the act of replying, we were automatically subscribed:

    >>> ubrowser.getControl('Unsubscribe from emails')
    <SubmitControl name=None type='submitbutton'>

The resulting email notification was sent to the admin user and not to us:

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['admin@ututi.lt']

Now, if, say, the admin posts a message, we will receive an email:

    >>> browser.getLink('Forum').click()
    >>> browser.getLink("What's up?").click()
    >>> browser.getControl(name='message').value = 'Indeed!'
    >>> browser.getForm(id="forum_reply_form").submit()

    >>> msg = mail_queue.pop()
    >>> msg.recipients
    ['user@ututi.lt']

Let's unsubscribe from emails.

    >>> ubrowser.getControl('Unsubscribe from emails').click()

Now any further replies will not be sent to us.

    >>> ubrowser.getControl(name='message').value = 'Right!'
    >>> ubrowser.getForm(id="forum_reply_form").submit()

    >>> mail_queue.pop()
    <EmailInfo sender='info@ututi.lt' recipients=['admin@ututi.lt']>

Since we unsubscribed explicitly, we will not be automatically resubscribed
again:

    >>> ubrowser.getControl('Subscribe to emails')
    <SubmitControl name=None type='submitbutton'>

Forum-wide subscriptions
========================

We can subscribe to the entire forum. Then we will be automatically
subscribed to any new threads:

    >>> ubrowser.getLink('Back to the topic list').click()

    ## >>> ubrowser.getControl('Get email').click()

(Because of a TestBrowser bug, we have to do this by hand.)

    >>> action_url = ubrowser.getControl('Get email').mech_form.action
    >>> res = app.post("/login",
    ...                params={'login': 'user@ututi.lt', 'password': 'password'})
    >>> res = app.post(action_url)

Now, the admin creates another thread:

    >>> browser.getLink('Back to the topic list').click()

    >>> browser.getControl('New topic').click()
    >>> browser.getControl(name='title').value = "Some news"
    >>> browser.getControl(name='message').value = "Notice this?"
    >>> browser.getControl('Post').click()

And the user is automatically subscribed to it:

    >>> mail_queue.pop()
    <EmailInfo sender='info@ututi.lt' recipients=['user@ututi.lt']>
