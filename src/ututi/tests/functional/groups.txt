Group adding and import
=======================

    >>> from pkg_resources import resource_stream
    >>> def make_file(filename):
    ...     stream = resource_stream("ututi.tests.functional.import", filename)
    ...     return (stream, 'text/plain', filename)

A list of all groups is shown at /groups.

    >>> browser = Browser.logIn()

    >>> browser.open('http://localhost/admin/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Moderatoriai (2)
    Testing group (2)

The link of the group leads to its home page.

    >>> browser.getLink('Moderatoriai').click()
    >>> browser.url
    'http://localhost/group/moderators/home'
    >>> browser.printQuery('//li[@class="current"]//a/text()')
    News wall

We can edit the group's information.

   >>> browser.getLink('Edit').click()
   >>> browser.url
   'http://localhost/group/moderators/edit'

   >>> browser.getControl('Group title').value
   'Moderatoriai'

   >>> browser.getControl('Group title').value = 'Ututi moderatoriai'
   >>> browser.getControl('Description').value = 'Ututi moderatorių grupė'
   >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
   >>> browser.getControl('Save').click()
   >>> browser.printQuery('id("moduleMenu")//li[@class="current"]//a/text()')
   News wall

   >>> browser.printQuery("id('group_info_portlet-content')//img[@id='group-logo']")
   <img id="group-logo" src="/group/moderators/logo/70/70" alt="logo" />

   >>> browser.printQuery("id('group_info_portlet-content')//h2/text()")
   Ututi moderatoriai

We can add a group at the url /groups/add.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'test'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl(name='location-0').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
    >>> browser.getControl('Year').value = ['2009']
    >>> browser.getControl('Continue').click()

After creating the group we should be redirected to the subject selection view:

    >>> browser.url
    'http://localhost/group/test/invite_members_step'

The group's logo is displayed in a portlet.

    >>> browser.printQuery("id('group_info_portlet-content')//img[@id='group-logo']")
    <img id="group-logo" src="/group/test/logo/70/70" alt="logo" />

Let's see what the group's default home page looks like:

    >>> browser.open('http://localhost/group/test')

However, group ids are checked for uniqueness.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'Test'
    >>> browser.getControl(name='location-0').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl('Continue').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Such id already exists, choose a different one.

And they must be valid local parts of email addresses.

    >>> browser.getControl('Group email address').value = 'test test'
    >>> browser.getControl('Continue').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

Slashes are also not allowed
    >>> browser.getControl('Group email address').value = 'test/test'
    >>> browser.getControl('Continue').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

    >>> browser.getControl('Group email address').value = 'test\test'
    >>> browser.getControl('Continue').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

And plus signs for that matter
    >>> browser.getControl('Group email address').value = 'test+test'
    >>> browser.getControl('Continue').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

You can import more groups using the admin interface.

    >>> browser.open('http://localhost/admin/import_csv')
    >>> form = browser.getForm(name='import_groups')
    >>> csv_data = 'exgroup, Imported group, Group imported from the old system, 2008, mf, vu'
    >>> import cStringIO
    >>> form.getControl('CSV File').add_file(cStringIO.StringIO(csv_data),
    ...                                      'text/plain',
    ...                                       'users.csv')
    >>> form.getControl('Upload').click()
    >>> browser.open('http://localhost/admin/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Ututi moderatoriai (2)
    Testing group (2)
    Test group (1)
    Imported group (0)
