Group adding and import
=======================

    >>> from pkg_resources import resource_stream
    >>> def make_file(filename):
    ...     stream = resource_stream("ututi.tests.functional.import", filename)
    ...     return (stream, 'text/plain', filename)

A list of all groups is show at /groups.

    >>> browser = Browser()
    >>> browser.open('http://localhost/')
    >>> form = browser.getForm('login_form')
    >>> form.getControl('Email').value = "admin@ututi.lt"
    >>> form.getControl('Password').value = "asdasd"
    >>> form.getControl('Login').click()

    >>> browser.open('http://localhost/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Moderatoriai

The link of the group leads to its home page.

    >>> browser.getLink('Moderatoriai').click()
    >>> browser.url
    'http://localhost/group/moderators'
    >>> browser.printQuery('//h1/text()')
    Moderatoriai, 2009

We can edit the group's information.
   >>> browser.getLink('Edit').click()
   >>> browser.url
   'http://localhost/group/moderators/edit'
   >>> browser.getControl('Title').value
   'Moderatoriai'
   >>> browser.getControl('Title').value = 'Ututi moderatoriai'
   >>> browser.getControl('Description').value = 'Ututi moderatorių grupė'
   >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
   >>> browser.getControl('Save').click()
   >>> browser.printQuery('//h1/text()')
   Ututi moderatoriai, 1999
   >>> browser.printQuery("id('group_info_portlet')//img")
   <img id="group-logo" src="/group/moderators/logo/70" alt="logo" />
   >>> browser.printQuery("id('group_info_portlet')//h4/text()")
   Ututi moderatoriai
   >>> browser.printQuery("id('group_info_portlet')//div[@class='description small']/text()")
   Ututi moderatorių grupė

We can add a group at the url /groups/add.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'test'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl('Specify the school').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
    >>> browser.getControl('Save').click()
    >>> browser.printQuery('//h1/text()')
    Test group, 2009

The group's logo is displayed in a portlet.

    >>> browser.printQuery("id('group_info_portlet')//img")
    <img id="group-logo" src="/group/test/logo/70" alt="logo" />

The group's default page is empty at the moment and we are notified of this.

    >>> browser.printQuery("id('group_page')//div[@class='content']/text()")
    The group's page is empty. Enter your description.

If we click the link to edit the page, we are redirected to a form for this.

    >>> browser.getLink('Edit', url="edit_page").click()
    >>> browser.getControl('Content').value = 'This is our group'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("id('group_page')//div[@class='content']/text()")
    <BLANKLINE>
    This is our group

If we want to, we can hide the group's page by clicking on a link.
    >>> browser.getLink('Hide').click()
    >>> browser.printQuery("id('group_page')//div[@class='content']/text()")

However, group ids are checked for uniqueness.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'test'
    >>> browser.getControl('Specify the school').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Such id already exists, choose a different one.

And they must be valid local parts of email addresses.

    >>> browser.getControl('Group email address').value = 'test test'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

If you log in, you should be able to see the groups you are a member
of in your home page (at least for now):

    >>> browser = Browser()
    >>> browser.open('http://localhost/')
    >>> form = browser.getForm('login_form')
    >>> form.getControl('Email').value = "admin@ututi.lt"
    >>> form.getControl('Password').value = "asdasd"
    >>> form.getControl('Login').click()

    >>> browser.printQuery("id('group_portlet_header')")
    <h3 id="group_portlet_header">
      My groups
    </h3>

    >>> browser.printQuery("id('group_portlet_content')")
    <div class="content" id="group_portlet_content">
      <ul>
        <li>
          <a href="/group/moderators">Ututi moderatoriai</a>
        </li>
      </ul>
    </div>

You can import more groups using the admin interface.

    >>> browser.open('http://localhost/admin')
    >>> form = browser.getForm(name='import_groups')
    >>> csv_data = 'exgroup, Imported group, Group imported from the old system, 2008, mf, vu'
    >>> import cStringIO
    >>> form.getControl('CSV File').add_file(cStringIO.StringIO(csv_data),
    ...                                      'text/plain',
    ...                                       'users.csv')
    >>> form.getControl('Upload').click()
    >>> browser.open('http://localhost/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Ututi moderatoriai
    Test group
    Imported group

And you can import group memberships using the admin interface too.

    >>> browser.open('http://localhost/admin')
    >>> form = browser.getForm(name='import_group_members')
    >>> csv_data = 'exgroup, admin@ututi.lt, True'
    >>> import cStringIO
    >>> form.getControl('CSV File').add_file(cStringIO.StringIO(csv_data),
    ...                                      'text/plain',
    ...                                       'group_members.csv')
    >>> form.getControl('Upload').click()
    >>> browser.open('http://localhost/group/exgroup/members')
    >>> browser.printQuery("id('group_member_list')//li/text()")
    Adminas Adminovix
