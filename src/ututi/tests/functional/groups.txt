Group adding and import
=======================

    >>> from pkg_resources import resource_stream
    >>> def make_file(filename):
    ...     stream = resource_stream("ututi.tests.functional.import", filename)
    ...     return (stream, 'text/plain', filename)

A list of all groups is show at /groups.

    >>> browser = Browser.logIn()

    >>> browser.open('http://localhost/admin/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Moderatoriai (1)

The link of the group leads to its home page.

    >>> browser.getLink('Moderatoriai').click()
    >>> browser.url
    'http://localhost/group/moderators'
    >>> browser.printQuery('id("tabs")//div[@class="tab active"]//a/text()')
    What's new?

We can edit the group's information.

   >>> browser.getLink('Edit').click()
   >>> browser.url
   'http://localhost/group/moderators/edit'

   >>> browser.getControl('Title').value
   'Moderatoriai'

   >>> browser.getControl('Title').value = 'Ututi moderatoriai'
   >>> browser.getControl('Description').value = 'Ututi moderatorių grupė'
   >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
   >>> browser.getControl('Save').click()
   >>> browser.printQuery('id("tabs")//div[@class="tab active"]//a/text()')
   What's new?

   >>> browser.printQuery("id('group_info_portlet')//img")
   <img id="group-logo" src="/group/moderators/logo/70" alt="logo" />

   >>> browser.printQuery("id('group_info_portlet')//h4/text()")
   Ututi moderatoriai

   >>> browser.printQuery("id('group_info_portlet')//div[@class='description small']/text()")
   Ututi moderatorių grupė

We can add a group at the url /groups/add.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'test'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl(name='location-0').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group logo').add_file(*make_file('test_logo.png'))
    >>> browser.getControl('Save').click()

After creating the group we should be redirected to the subject selection view:

    >>> browser.printQuery('//h2/text()')
    Watched subjects
    Recommended subjects

The group's logo is displayed in a portlet.

    >>> browser.printQuery("id('group_info_portlet')//img")
    <img id="group-logo" src="/group/test/logo/70" alt="logo" />

Let's see what the group's default home page looks like:

    >>> browser.open('http://localhost/group/test')

The group's default page is empty at the moment and we are notified of this.

    >>> browser.printQuery("id('group_page')//div[@class='content']/text()")
    The group's page is empty. Enter your description.

If we click the link to edit the page, we are redirected to a form for this.

    >>> browser.getLink('Edit', url="edit_page").click()
    >>> browser.getControl('Content').value = 'This is our group'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("id('group_page')//div[@class='content']/text()")
    <BLANKLINE>
    This is our group

However, group ids are checked for uniqueness.

    >>> browser.open('http://localhost/groups/add')
    >>> browser.getControl('Group email address').value = 'Test'
    >>> browser.getControl(name='location-0').value = 'Vilniaus universitetas'
    >>> browser.getControl('Group title').value = 'Test group'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Such id already exists, choose a different one.

And they must be valid local parts of email addresses.

    >>> browser.getControl('Group email address').value = 'test test'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

Slashes are also not allowed
    >>> browser.getControl('Group email address').value = 'test/test'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

    >>> browser.getControl('Group email address').value = 'test\test'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.

And plus signs for that matter
    >>> browser.getControl('Group email address').value = 'test+test'
    >>> browser.getControl('Save').click()
    >>> browser.printQuery("//span[@class='error-message']/text()")
    Id cannot be used as an email address.


If you log in, you should be able to see the groups you are a member
of in your home page (at least for now):

    >>> browser = Browser.logIn()

    >>> browser.printQuery("id('group_portlet_header')")
    <h3 id="group_portlet_header">
      My groups
    </h3>

    >>> browser.printQuery("id('group_portlet_content')")
    <div class="content" id="group_portlet_content">
      <ul>
        <li>
          <div class="group-listing-item">
            <img class="group-logo" src="/group/moderators/logo/25/25" alt="logo" />
            <a href="/group/moderators">Ututi moderatoriai</a>
                (1 member)
                <br class="clear-left" />
          </div>
        </li>
        <li>
          <div class="group-listing-item">
            <img class="group-logo" src="/group/test/logo/25/25" alt="logo" />
            <a href="/group/test">Test group</a>
                (1 member)
                <br class="clear-left" />
          </div>
        </li>
      </ul>
      <div class="footer">
        <a class="more" href="/profile/search?obj_type=group">More groups</a>
        <span>
          <form action="/groups/add" class="button-to" method="post">
            <div>
              <span class="btn">
                <input type="submit" value="Create group" />
              </span>
            </div>
          </form>
          <img alt="Create your group, invite your classmates and use the mailing list, upload private group files" class="tooltip" src="/images/details/icon_question.png" />
        </span>
      </div>
      <br style="clear: both; height: 1px;" />
    </div>

You can import more groups using the admin interface.

    >>> browser.open('http://localhost/admin')
    >>> form = browser.getForm(name='import_groups')
    >>> csv_data = 'exgroup, Imported group, Group imported from the old system, 2008, mf, vu'
    >>> import cStringIO
    >>> form.getControl('CSV File').add_file(cStringIO.StringIO(csv_data),
    ...                                      'text/plain',
    ...                                       'users.csv')
    >>> form.getControl('Upload').click()
    >>> browser.open('http://localhost/admin/groups')
    >>> browser.printQuery("id('group_list')//li/a/text()")
    Ututi moderatoriai (1)
    Test group (1)
    Imported group (0)
